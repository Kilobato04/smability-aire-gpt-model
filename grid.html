<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smability Dashboard - CDMX</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; background: #0f172a; font-family: 'Inter', sans-serif; color: #e2e8f0; overflow: hidden; }
        #map { height: 100vh; width: 100%; background: #0f172a; }
        
        .sidebar {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            background: rgba(15, 23, 42, 0.90); width: 300px;
            border-radius: 12px; border: 1px solid rgba(56, 189, 248, 0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.6); backdrop-filter: blur(10px);
            display: flex; flex-direction: column; overflow: hidden; max-height: calc(100vh - 40px);
        }

        .header { padding: 20px 20px 10px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); background: linear-gradient(to right, rgba(56,189,248,0.1), transparent); }
        h1 { margin: 0; font-size: 18px; font-weight: 600; color: #38bdf8; letter-spacing: -0.5px; }
        .subtitle { font-size: 11px; color: #94a3b8; margin-top: 4px; text-transform: uppercase; letter-spacing: 1px; }
        
        .status-bar {
            padding: 10px 20px; font-size: 11px; color: #fff;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center;
        }
        .live-dot { height: 8px; width: 8px; background-color: #22c55e; border-radius: 50%; display: inline-block; margin-right: 5px; box-shadow: 0 0 5px #22c55e; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .controls { padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-var {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #cbd5e1;
            padding: 10px; border-radius: 8px; cursor: pointer; font-size: 11px; text-align: center;
            transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .btn-var:hover { background: rgba(255,255,255,0.1); }
        .btn-var.active { background: rgba(56, 189, 248, 0.2); border-color: #38bdf8; color: #fff; font-weight: 600; }
        .btn-air { border-color: rgba(56, 189, 248, 0.4); }

        .legend-panel { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); }
        .legend-title { font-size: 12px; color: #e2e8f0; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .legend-bar { height: 12px; border-radius: 6px; position: relative; margin-bottom: 8px; }
        .legend-labels { display: flex; justify-content: space-between; font-size: 10px; color: #94a3b8; font-family: 'Roboto Mono'; }

        .stats-row { display: flex; justify-content: space-between; margin-top: 15px; }
        .stat-item { text-align: center; }
        .stat-val { display: block; font-size: 16px; font-weight: 600; color: #fff; font-family: 'Roboto Mono'; }
        .stat-lbl { font-size: 9px; color: #64748b; text-transform: uppercase; }

        .leaflet-popup-content-wrapper { background: #ffffff !important; color: #1e293b !important; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: none; }
        .leaflet-popup-tip { background: #ffffff !important; }
        .leaflet-popup-content { margin: 10px 12px; line-height: 1.5; }
        
        #loading { text-align:center; padding:20px; color:#94a3b8; font-style:italic; }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="header">
            <h1>Smability AI</h1>
            <div class="subtitle">Monitor del Valle de M√©xico</div>
        </div>
        
        <div class="status-bar">
            <span><span class="live-dot"></span>LIVE API</span>
            <span id="update-time">Cargando...</span>
        </div>

        <div id="loading">Conectando a AWS Lambda...</div>

        <div id="main-content" style="display:none;">
            <div class="controls">
                <div class="btn-var btn-air" onclick="setMode('ias', this)">üö¶ IAS</div>
                <div class="btn-var active btn-air" onclick="setMode('o3', this)">üî¥ O3</div>
                <div class="btn-var btn-air" onclick="setMode('pm10', this)">üü§ PM10</div>
                <div class="btn-var btn-air" onclick="setMode('pm25', this)">üü£ PM2.5</div>
                
                <div class="btn-var" onclick="setMode('tmp', this)">üå°Ô∏è Temp</div>
                <div class="btn-var" onclick="setMode('rh', this)">üíß Hum</div>
                <div class="btn-var" onclick="setMode('wsp', this)">üí® Viento</div>
                <div class="btn-var" style="grid-column: span 1;" onclick="setMode('alt', this)">‚õ∞Ô∏è Alt</div>
                <div class="btn-var" style="grid-column: span 1;" onclick="setMode('building_vol', this)">üèôÔ∏è Urbano</div>
            </div>

            <div class="legend-panel">
                <div class="legend-title">
                    <span id="legend-name">Ozono (O3)</span>
                    <span id="legend-unit" style="color: #64748b;">ppb</span>
                </div>
                <div class="legend-bar" id="color-bar"></div>
                <div class="legend-labels" id="legend-ticks"></div>

                <div class="stats-row">
                    <div class="stat-item"><span class="stat-val" id="stat-min">--</span><span class="stat-lbl">M√≠n</span></div>
                    <div class="stat-item"><span class="stat-val" id="stat-avg">--</span><span class="stat-lbl">Prom</span></div>
                    <div class="stat-item"><span class="stat-val" id="stat-max">--</span><span class="stat-lbl">M√°x</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_URL = "https://vuy3dprsp2udtuelnrb5leg6ay0ygsky.lambda-url.us-east-1.on.aws/?mode=map";

        // CONFIGURACI√ìN DEL MAPA: preferCanvas: true es la CLAVE para evitar el lag
        const map = L.map('map', { 
            zoomControl: false,
            preferCanvas: true 
        }).setView([19.4326, -99.1332], 10);
        
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: 'Smability AI', maxZoom: 19
        }).addTo(map);

        const CONFIG = {
            ias: { name: '√çndice Aire y Salud', unit: 'Pts', min: 0, max: 200, stops: [0, 50, 100, 150, 200, 300], colors: ['#00e400', '#ffff00', '#ff7e00', '#ff0000', '#8f3f97', '#7e0023'] },
            o3: { name: 'Ozono (O3)', unit: 'ppb', min: 0, max: 200, stops: [0, 50, 100, 150, 200, 250], colors: ['#00e400', '#ffff00', '#ff7e00', '#ff0000', '#8f3f97', '#7e0023'] },
            pm10: { name: 'Part√≠culas PM10', unit: '¬µg/m¬≥', min: 0, max: 215, stops: [0, 45, 75, 130, 215, 300], colors: ['#00e400', '#ffff00', '#ff7e00', '#ff0000', '#8f3f97', '#7e0023'] },
            pm25: { name: 'Part√≠culas PM2.5', unit: '¬µg/m¬≥', min: 0, max: 150, stops: [0, 25, 45, 80, 147, 200], colors: ['#00e400', '#ffff00', '#ff7e00', '#ff0000', '#8f3f97', '#7e0023'] },
            tmp: { name: 'Temperatura', unit: '¬∞C', min: 0, max: 35, stops: [0, 10, 20, 30, 35], colors: ['#0000ff', '#00ffff', '#ffff00', '#ff0000', '#800000'] },
            rh: { name: 'Humedad', unit: '%', min: 0, max: 100, stops: [0, 25, 50, 75, 100], colors: ['#8d6e63', '#a5d6a7', '#4dd0e1', '#0288d1', '#01579b'] },
            wsp: { name: 'Viento', unit: 'm/s', min: 0, max: 15, stops: [0, 3, 6, 9, 15], colors: ['#ffffff', '#b3e5fc', '#29b6f6', '#0277bd', '#4a148c'] },
            alt: { name: 'Altitud', unit: 'm', min: 2230, max: 4000, stops: [2230, 2260, 2400, 2900, 3500, 4000], colors: ['#0d47a1', '#1b5e20', '#8bc34a', '#fbc02d', '#795548', '#eeeeee'] },
            building_vol: { name: 'Volumen Construido', unit: 'm¬≥', min: 0, max: 1200000, stops: [0, 10000, 100000, 400000, 800000, 1200000], colors: ['#111111', '#2c2c2c', '#666666', '#ef4444', '#f59e0b', '#ffffff'] }
        };

        let globalData = null;
        let currentMetric = 'o3';
        let geoLayer = null;

        fetch(API_URL)
            .then(response => response.json())
            .then(data => {
                globalData = data;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                if(data.length > 0 && data[0].timestamp) {
                    const dateObj = new Date(data[0].timestamp);
                    const timeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    document.getElementById('update-time').innerText = "Act: " + timeStr;
                }
                renderMap();
            })
            .catch(err => {
                document.getElementById('loading').innerHTML = `<span style="color:red">Error API: ${err.message}</span>`;
            });

        function getColor(val, metric) {
            const conf = CONFIG[metric];
            let v = Math.max(conf.min, Math.min(val, conf.max));
            const stops = conf.stops;
            for (let i = 0; i < stops.length - 1; i++) {
                if (v >= stops[i] && v <= stops[i+1]) {
                    const t = (v - stops[i]) / (stops[i+1] - stops[i]);
                    const c1 = hexToRgb(conf.colors[i]);
                    const c2 = hexToRgb(conf.colors[i+1]);
                    return `rgb(${lerp(c1.r, c2.r, t)}, ${lerp(c1.g, c2.g, t)}, ${lerp(c1.b, c2.b, t)})`;
                }
            }
            return conf.colors[0];
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : {r:0,g:0,b:0};
        }
        function lerp(start, end, t) { return Math.round(start + (end - start) * t); }

        function renderMap() {
            if (!globalData) return;
            if (geoLayer) map.removeLayer(geoLayer);

            const conf = CONFIG[currentMetric];
            const RECT_SIZE = 0.01 / 2;

            const rectangles = [];
            
            // Optimization: Usamos un array simple para agregar capas al Canvas
            globalData.forEach(p => {
                let val = p[currentMetric];
                if (currentMetric === 'alt') val = p.altitude;
                if (currentMetric === 'building_vol') val = p.building_vol;
                
                if (val === undefined || val === null) return;

                const color = getColor(val, currentMetric);
                const bounds = [[p.lat - RECT_SIZE, p.lon - RECT_SIZE], [p.lat + RECT_SIZE, p.lon + RECT_SIZE]];
                
                const isStation = p.station ? true : false;
                const strokeColor = isStation ? '#ffffff' : color;
                
                // Con Canvas, quitamos bordes a las celdas normales para rendimiento
                // Solo las estaciones llevan borde grueso
                const weight = isStation ? 2 : 0;
                
                const rect = L.rectangle(bounds, {
                    color: strokeColor, weight: weight, fillOpacity: 0.75, fillColor: color,
                    interactive: true // Necesario para el popup
                });

                const riskColor = (p.risk === 'Alto' || p.risk === 'Muy Alto' || p.risk === 'Extremadamente Alto') ? '#ef4444' : (p.risk === 'Moderado' ? '#eab308' : '#22c55e');
                const loc_text = (p.mun && p.mun !== 'N/A') ? `üìç ${p.mun}, ${p.edo}` : `üìç Coordenadas: ${p.lat.toFixed(2)}, ${p.lon.toFixed(2)}`;

                let headerHTML = `<div style="font-size:10px; color:#64748b; text-align:right; margin-bottom:4px; font-weight:600;">üïí ${p.timestamp || 'Live'}</div>`;
                if (isStation) {
                    headerHTML += `<div style="background:#38bdf8; color:#0f172a; padding:4px 8px; border-radius:4px; margin-bottom:8px; text-align:center; font-weight:bold; font-size:12px;">üì° Estaci√≥n: ${p.station}</div>`;
                }

                rect.bindPopup(`
                    <div style="font-family:'Inter'; color:#334155; min-width: 175px;">
                        ${headerHTML}
                        <div style="margin-bottom:8px; font-size:11px; font-weight:600; color:#3b82f6; border-bottom:1px solid #e2e8f0; padding-bottom:4px;">${loc_text}</div>
                        <div style="display:grid; grid-template-columns: 1fr auto; gap: 5px; font-size:12px;">
                            <span style="font-weight:600; color:#000;">üö¶ IAS:</span> <span style="font-weight:bold;">${(p.ias||0).toFixed(0)} pts</span>
                            <span style="font-weight:600; color:#000;">‚ò¢Ô∏è Riesgo:</span> <span style="font-weight:bold; color:${riskColor};">${p.risk || 'N/A'}</span>
                            <span style="font-weight:600; color:#000; white-space:nowrap;">üî¥ O3${p.dominant === 'O3' ? ' <b style="color:#ef4444;">(Dom)</b>' : ''}:</span> <span>${p.o3.toFixed(1)} ppb</span>
                            <span style="font-weight:600; color:#000; white-space:nowrap;">üü§ PM10${p.dominant === 'PM10' ? ' <b style="color:#a855f7;">(Dom)</b>' : ''}:</span> <span>${(p.pm10||0).toFixed(1)} ¬µg</span>
                            <span style="font-weight:600; color:#000; white-space:nowrap;">üü£ PM2.5${p.dominant === 'PM2.5' ? ' <b style="color:#a855f7;">(Dom)</b>' : ''}:</span> <span>${(p.pm25||0).toFixed(1)} ¬µg</span>
                            <hr style="grid-column: span 2; border:0; border-top:1px solid #e2e8f0; width:100%; margin:2px 0;">
                            <span style="color:#475569;">üèôÔ∏è Vol:</span> <span>${(p.building_vol/1000).toFixed(0)}k m¬≥</span>
                            <span style="color:#475569;">üå°Ô∏è Temp:</span> <span>${p.tmp?.toFixed(1)} ¬∞C</span>
                            <span style="color:#475569;">‚õ∞Ô∏è Alt:</span> <span>${p.altitude?.toFixed(0)} m</span>
                        </div>
                    </div>
                `);
                
                rect.on('mouseover', function(){ this.setStyle({ fillOpacity: 0.9, weight: isStation?3:1, color: '#fff' })});
                rect.on('mouseout', function(){ this.setStyle({ fillOpacity: 0.75, weight: weight, color: strokeColor })});

                rectangles.push(rect);
            });

            geoLayer = L.layerGroup(rectangles).addTo(map);
            
            // Stats
            const vals = globalData.map(p => {
                let v = p[currentMetric];
                if (currentMetric === 'alt') v = p.altitude;
                if (currentMetric === 'building_vol') v = p.building_vol;
                return v || 0;
            });
            updateLegend(conf, Math.min(...vals), Math.max(...vals), vals.reduce((a,b)=>a+b,0)/vals.length);
        }

        function updateLegend(conf, min, max, avg) {
            document.getElementById('legend-name').innerText = conf.name;
            document.getElementById('legend-unit').innerText = conf.unit;
            let gradStr = 'linear-gradient(to right';
            for(let i=0; i<conf.stops.length; i++) {
                let pct = ((conf.stops[i] - conf.min) / (conf.max - conf.min)) * 100;
                gradStr += `, ${conf.colors[i]} ${pct}%`;
            }
            gradStr += ')';
            document.getElementById('color-bar').style.background = gradStr;
            document.getElementById('legend-ticks').innerHTML = conf.stops.map(s => `<span>${s}</span>`).join('');
            document.getElementById('stat-min').innerText = min.toFixed(1);
            document.getElementById('stat-max').innerText = max.toFixed(1);
            document.getElementById('stat-avg').innerText = avg.toFixed(1);
        }

        window.setMode = (mode, el) => {
            currentMetric = mode;
            document.querySelectorAll('.btn-var').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            renderMap();
        };
    </script>
</body>
</html>
