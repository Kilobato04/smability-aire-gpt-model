<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smability Dashboard - CDMX</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; background: #0f172a; font-family: 'Inter', sans-serif; color: #e2e8f0; overflow: hidden; }
        #map { height: 100vh; width: 100%; background: #0f172a; }
        
        .sidebar {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            background: rgba(15, 23, 42, 0.95); width: 300px;
            border-radius: 12px; border: 1px solid rgba(56, 189, 248, 0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.6); backdrop-filter: blur(10px);
            display: flex; flex-direction: column; overflow: hidden; max-height: calc(100vh - 40px);
        }

        .header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); background: linear-gradient(to right, rgba(56,189,248,0.1), transparent); }
        h1 { margin: 0; font-size: 18px; font-weight: 600; color: #38bdf8; letter-spacing: -0.5px; }
        .subtitle { font-size: 11px; color: #94a3b8; margin-top: 4px; text-transform: uppercase; letter-spacing: 1px; }

        .controls { padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-var {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #cbd5e1;
            padding: 10px; border-radius: 8px; cursor: pointer; font-size: 11px; text-align: center;
            transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .btn-var:hover { background: rgba(255,255,255,0.1); }
        .btn-var.active { background: rgba(56, 189, 248, 0.2); border-color: #38bdf8; color: #fff; font-weight: 600; }
        .btn-air { border-color: rgba(56, 189, 248, 0.4); }

        .upload-area {
            margin: 0 15px; border: 2px dashed #475569; border-radius: 8px; padding: 15px;
            text-align: center; cursor: pointer; transition: all 0.2s;
        }
        .upload-area:hover { border-color: #94a3b8; background: rgba(255,255,255,0.02); }
        .upload-txt { font-size: 11px; color: #64748b; }

        .legend-panel { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); }
        .legend-title { font-size: 12px; color: #e2e8f0; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .legend-bar { height: 12px; border-radius: 6px; position: relative; margin-bottom: 8px; }
        .legend-labels { display: flex; justify-content: space-between; font-size: 10px; color: #94a3b8; font-family: 'Roboto Mono'; }

        .stats-row { display: flex; justify-content: space-between; margin-top: 15px; }
        .stat-item { text-align: center; }
        .stat-val { display: block; font-size: 16px; font-weight: 600; color: #fff; font-family: 'Roboto Mono'; }
        .stat-lbl { font-size: 9px; color: #64748b; text-transform: uppercase; }

        .leaflet-popup-content-wrapper {
            background: #ffffff !important; color: #1e293b !important;
            border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: none;
        }
        .leaflet-popup-tip { background: #ffffff !important; }
        .leaflet-popup-content { margin: 10px 12px; line-height: 1.5; }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="header">
            <h1>Smability AI</h1>
            <div class="subtitle">Modelo V35 (Full Stack Urbano)</div>
        </div>

        <div class="upload-area" id="drop-zone" onclick="document.getElementById('fileInput').click()">
            <div style="font-size: 20px; margin-bottom: 5px;">üìÇ</div>
            <div class="upload-txt" id="file-name">Arrastra latest_grid.json</div>
            <input type="file" id="fileInput" accept=".json" style="display: none;" />
        </div>

        <div class="controls">
            <div class="btn-var btn-air" onclick="setMode('ias', this)">üö¶ IAS</div>
            <div class="btn-var active btn-air" onclick="setMode('o3', this)">üî¥ O3</div>
            <div class="btn-var btn-air" onclick="setMode('pm10', this)">üü§ PM10</div>
            <div class="btn-var btn-air" onclick="setMode('pm25', this)">üü£ PM2.5</div>
            
            <div class="btn-var" onclick="setMode('tmp', this)">üå°Ô∏è Temp</div>
            <div class="btn-var" onclick="setMode('wsp', this)">üí® Viento</div>
            <div class="btn-var" onclick="setMode('alt', this)">‚õ∞Ô∏è Alt</div>
            <div class="btn-var" onclick="setMode('building_vol', this)">üèôÔ∏è Edificios</div>
        </div>

        <div class="legend-panel">
            <div class="legend-title">
                <span id="legend-name">Ozono (O3)</span>
                <span id="legend-unit" style="color: #64748b;">ppb</span>
            </div>
            <div class="legend-bar" id="color-bar"></div>
            <div class="legend-labels" id="legend-ticks"></div>

            <div class="stats-row">
                <div class="stat-item"><span class="stat-val" id="stat-min">--</span><span class="stat-lbl">M√≠nimo</span></div>
                <div class="stat-item"><span class="stat-val" id="stat-avg">--</span><span class="stat-lbl">Promedio</span></div>
                <div class="stat-item"><span class="stat-val" id="stat-max">--</span><span class="stat-lbl">M√°ximo</span></div>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { zoomControl: false }).setView([19.4326, -99.1332], 10);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: 'Smability AI', maxZoom: 19
        }).addTo(map);

        const CONFIG = {
            ias: { name: '√çndice Aire y Salud', unit: 'Pts', min: 0, max: 200, stops: [0, 50, 100, 150, 200], colors: ['#00e400', '#ffff00', '#ff7e00', '#ff0000', '#8f3f97'] },
            o3: { name: 'Ozono (O3)', unit: 'ppb', min: 0, max: 200, stops: [0, 50, 100, 150, 200], colors: ['#00e400', '#ffff00', '#ff7e00', '#ff0000', '#8f3f97'] },
            pm10: { name: 'Part√≠culas PM10', unit: '¬µg/m¬≥', min: 0, max: 215, stops: [0, 45, 75, 130, 215], colors: ['#00e400', '#ffff00', '#ff7e00', '#ff0000', '#8f3f97'] },
            pm25: { name: 'Part√≠culas PM2.5', unit: '¬µg/m¬≥', min: 0, max: 150, stops: [0, 25, 45, 80, 147], colors: ['#00e400', '#ffff00', '#ff7e00', '#ff0000', '#8f3f97'] },
            
            tmp: { name: 'Temperatura', unit: '¬∞C', min: 0, max: 35, stops: [0, 10, 20, 30, 35], colors: ['#0000ff', '#00ffff', '#ffff00', '#ff0000', '#800000'] },
            wsp: { name: 'Viento', unit: 'm/s', min: 0, max: 15, stops: [0, 3, 6, 9, 15], colors: ['#ffffff', '#b3e5fc', '#29b6f6', '#0277bd', '#4a148c'] },
            
            alt: { name: 'Altitud', unit: 'm', min: 2200, max: 4200, stops: [2200, 2350, 2800, 3500, 4200], colors: ['#1b5e20', '#8bc34a', '#fbc02d', '#8d6e63', '#eeeeee'] },
            
            // --- NUEVA CAPA DE EDIFICIOS ---
            // Escala logar√≠tmica visual: de bosque (0) a rascacielos/denso (Alto volumen)
            building_vol: { 
                name: 'Densidad Edificios', unit: 'm¬≥/km¬≤', 
                min: 0, max: 500000, 
                stops: [0, 5000, 50000, 200000, 500000], 
                colors: ['#111111', '#444444', '#888888', '#cc4444', '#ff0000'] 
            }
        };

        let globalData = null;
        let currentMetric = 'o3';
        let geoLayer = null;

        function getColor(val, metric) {
            const conf = CONFIG[metric];
            let t = (val - conf.min) / (conf.max - conf.min);
            t = Math.max(0, Math.min(1, t));
            const segment = 1 / (conf.colors.length - 1);
            const idx = Math.floor(t / segment);
            const localT = (t % segment) / segment;
            const c1 = hexToRgb(conf.colors[Math.min(idx, conf.colors.length-1)]); 
            const c2 = hexToRgb(conf.colors[Math.min(idx + 1, conf.colors.length-1)]);
            return `rgb(${lerp(c1.r, c2.r, localT)}, ${lerp(c1.g, c2.g, localT)}, ${lerp(c1.b, c2.b, localT)})`;
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : {r:0,g:0,b:0};
        }
        function lerp(start, end, t) { return Math.round(start + (end - start) * t); }

        function renderMap() {
            if (!globalData) return;
            if (geoLayer) map.removeLayer(geoLayer);

            const conf = CONFIG[currentMetric];
            const RECT_SIZE = 0.01 / 2;

            const rectangles = [];
            let sum = 0, min = Infinity, max = -Infinity, validCount = 0;

            globalData.forEach(p => {
                let val = p[currentMetric];
                
                // Mapeos especiales
                if (currentMetric === 'alt') val = p.altitude;
                
                if (val === undefined || val === null) return;

                sum += val;
                if (val < min) min = val;
                if (val > max) max = val;
                validCount++;

                const color = getColor(val, currentMetric);
                const bounds = [[p.lat - RECT_SIZE, p.lon - RECT_SIZE], [p.lat + RECT_SIZE, p.lon + RECT_SIZE]];
                
                const isStation = p.station ? true : false;
                const strokeColor = isStation ? '#ffffff' : color; 
                const weight = isStation ? 2 : 0;
                
                const rect = L.rectangle(bounds, {
                    color: strokeColor, weight: weight, fillOpacity: 0.65, fillColor: color
                });

                // --- POPUP CON UBICACI√ìN ADMINISTRATIVA ---
                let headerHTML = `<div style="font-size:10px; color:#64748b; text-align:right; margin-bottom:4px; font-weight:600;">üïí ${p.timestamp || 'Live'}</div>`;
                
                if (isStation) {
                    headerHTML += `<div style="background:#38bdf8; color:#0f172a; padding:4px 8px; border-radius:4px; margin-bottom:8px; text-align:center; font-weight:bold; font-size:12px;">üì° Estaci√≥n: ${p.station}</div>`;
                }

                const riskColor = (p.risk === 'Alto' || p.risk === 'Muy Alto' || p.risk === 'Extremadamente Alto') ? '#ef4444' : (p.risk === 'Moderado' ? '#eab308' : '#22c55e');
                
                // Obtener ubicaci√≥n administrativa
                const loc_text = (p.mun && p.mun !== 'N/A') ? `üìç ${p.mun}, ${p.edo}` : `üìç Coordenadas: ${p.lat.toFixed(2)}, ${p.lon.toFixed(2)}`;

                rect.bindPopup(`
                    <div style="font-family:'Inter'; color:#334155; min-width: 175px;">
                        ${headerHTML}
                        
                        <div style="margin-bottom:8px; font-size:11px; font-weight:600; color:#3b82f6; border-bottom:1px solid #e2e8f0; padding-bottom:4px;">
                            ${loc_text}
                        </div>

                        <div style="display:grid; grid-template-columns: 1fr auto; gap: 5px; font-size:12px;">
                            <span style="font-weight:600; color:#000;">üö¶ IAS:</span> <span style="font-weight:bold;">${(p.ias||0).toFixed(0)} pts</span>
                            <span style="font-weight:600; color:#000;">‚ò¢Ô∏è Riesgo:</span> <span style="font-weight:bold; color:${riskColor};">${p.risk || 'N/A'}</span>
                            
                            <span style="font-weight:600; color:#000; white-space:nowrap;">üî¥ O3${p.dominant === 'O3' ? ' <b style="color:#ef4444;">(Dom)</b>' : ''}:</span> <span>${p.o3.toFixed(1)} ppb</span>
                            <span style="font-weight:600; color:#000; white-space:nowrap;">üü§ PM10${p.dominant === 'PM10' ? ' <b style="color:#a855f7;">(Dom)</b>' : ''}:</span> <span>${(p.pm10||0).toFixed(1)} ¬µg</span>
                            <span style="font-weight:600; color:#000; white-space:nowrap;">üü£ PM2.5${p.dominant === 'PM2.5' ? ' <b style="color:#a855f7;">(Dom)</b>' : ''}:</span> <span>${(p.pm25||0).toFixed(1)} ¬µg</span>
                            
                            <hr style="grid-column: span 2; border:0; border-top:1px solid #e2e8f0; width:100%; margin:2px 0;">
                            <span style="color:#475569;">üèôÔ∏è Vol:</span> <span>${(p.building_vol/1000).toFixed(0)}k m¬≥</span>
                            <span style="color:#475569;">üå°Ô∏è Temp:</span> <span>${p.tmp?.toFixed(1)} ¬∞C</span>
                            <span style="color:#475569;">‚õ∞Ô∏è Alt:</span> <span>${p.altitude?.toFixed(0)} m</span>
                        </div>
                    </div>
                `);
                
                rect.on('mouseover', function(){ this.setStyle({ fillOpacity: 0.9, weight: isStation?3:1, color: '#fff' })});
                rect.on('mouseout', function(){ this.setStyle({ fillOpacity: 0.65, weight: weight, color: strokeColor })});

                rectangles.push(rect);
            });

            geoLayer = L.layerGroup(rectangles).addTo(map);
            updateLegend(conf, min, max, sum/validCount);
        }

        function updateLegend(conf, min, max, avg) {
            document.getElementById('legend-name').innerText = conf.name;
            document.getElementById('legend-unit').innerText = conf.unit;
            document.getElementById('color-bar').style.background = `linear-gradient(to right, ${conf.colors.join(', ')})`;
            document.getElementById('legend-ticks').innerHTML = conf.stops.map(s => `<span>${s}</span>`).join('');
            document.getElementById('stat-min').innerText = min.toFixed(1);
            document.getElementById('stat-max').innerText = max.toFixed(1);
            document.getElementById('stat-avg').innerText = avg.toFixed(1);
        }

        window.setMode = (mode, el) => {
            currentMetric = mode;
            document.querySelectorAll('.btn-var').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            renderMap();
        };

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('fileInput');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
            dropZone.addEventListener(e, (ev) => { ev.preventDefault(); ev.stopPropagation(); });
        });

        dropZone.addEventListener('drop', (e) => loadFile(e.dataTransfer.files[0]));
        fileInput.addEventListener('change', (e) => loadFile(e.target.files[0]));

        function loadFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    globalData = JSON.parse(e.target.result);
                    document.getElementById('file-name').innerText = "‚úÖ " + file.name;
                    document.getElementById('drop-zone').style.borderColor = "#00e400";
                    renderMap();
                } catch(err) { alert("Error JSON: " + err); }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
