version: 0.2

env:
  variables:
    ECR_REPO_NAME: "smability-telegram-core"
    LAMBDA_BOT_NAME: "Smability-Chatbot"
    LAMBDA_SCHEDULER_NAME: "Smability-Scheduler"
    AWS_REGION: "us-east-1"

phases:
  pre_build:
    commands:
      - echo "ðŸ¤– Iniciando Build UNIFICADO..."
      - echo "ðŸ†” Obteniendo Account ID..."
      - export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
      - echo "ðŸ”‘ Logueando en ECR..."
      - "aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com"
      - REPOSITORY_URI=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO_NAME
      - IMAGE_TAG=latest

      # Verificar/Crear Repo (Con comillas para proteger el || )
      - "aws ecr describe-repositories --repository-names $ECR_REPO_NAME || aws ecr create-repository --repository-name $ECR_REPO_NAME"

      - echo "ðŸ”„ Sincronizando API Light..."
      - cp api_light/lambda_function.py app/airegpt_telegram/lambda_api_light.py

  build:
    commands:
      - echo "ðŸ“‚ Entrando a carpeta del mÃ³dulo..."
      - cd app/airegpt_telegram
      
      # TRUCO BASH: Limpiamos el ID sin usar awk (evitamos los dos puntos)
      - export CLEAN_TAG=${CODEBUILD_BUILD_ID##*:}
      - echo "ðŸ·ï¸ Tag limpio generado: $CLEAN_TAG"
      
      - echo "ðŸ³ Construyendo Docker..."
      - "docker build -t $REPOSITORY_URI:$IMAGE_TAG ."
      - "docker tag $REPOSITORY_URI:$IMAGE_TAG $REPOSITORY_URI:build-$CLEAN_TAG"

  post_build:
    commands:
      # Redefinimos CLEAN_TAG porque las variables no pasan de build a post_build
      - export CLEAN_TAG=${CODEBUILD_BUILD_ID##*:}
      
      - echo "â¬†ï¸ Subiendo a ECR..."
      - "docker push $REPOSITORY_URI:$IMAGE_TAG"
      - "docker push $REPOSITORY_URI:build-$CLEAN_TAG"
      
      - echo "ðŸ”„ Actualizando Lambdas..."
      # El > /dev/null a veces molesta a YAML, lo quitamos para ver logs completos y evitar errores
      - "aws lambda update-function-code --function-name $LAMBDA_BOT_NAME --image-uri $REPOSITORY_URI:$IMAGE_TAG"
      - "aws lambda update-function-code --function-name $LAMBDA_SCHEDULER_NAME --image-uri $REPOSITORY_URI:$IMAGE_TAG"
      
      - echo "âœ… Despliegue DOBLE completado."
