version: 0.2

env:
  variables:
    ECR_REPO_NAME: "smability-telegram-core"
    LAMBDA_BOT_NAME: "Smability-Chatbot"
    LAMBDA_SCHEDULER_NAME: "Smability-Scheduler"
    AWS_REGION: "us-east-1"

phases:
  pre_build:
    commands:
      - echo "ðŸ¤– Iniciando Build UNIFICADO..."
      - echo "ðŸ†” Obteniendo Account ID..."
      - export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
      - echo "ðŸ”‘ Logueando en ECR..."
      - "aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com"
      - REPOSITORY_URI=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO_NAME
      - IMAGE_TAG=latest

      # Crear repo si no existe (con comillas por si acaso)
      - "aws ecr describe-repositories --repository-names $ECR_REPO_NAME || aws ecr create-repository --repository-name $ECR_REPO_NAME"

      - echo "ðŸ”„ Sincronizando API Light..."
      - cp api_light/lambda_function.py app/airegpt_telegram/lambda_api_light.py

  build:
    commands:
      - echo "ðŸ“‚ Entrando a carpeta del mÃ³dulo..."
      - cd app/airegpt_telegram
      
      # ðŸ›¡ï¸ FIX YAML: Usamos comillas para que los dos puntos (:) no rompan el parser
      - "CLEAN_TAG=$(echo $CODEBUILD_BUILD_ID | awk -F: '{print $2}')"
      - echo "ðŸ·ï¸ Tag limpio generado: $CLEAN_TAG"
      
      - echo "ðŸ³ Construyendo Docker..."
      # ðŸ›¡ï¸ FIX YAML: Comillas aquÃ­ tambiÃ©n
      - "docker build -t $REPOSITORY_URI:$IMAGE_TAG ."
      - "docker tag $REPOSITORY_URI:$IMAGE_TAG $REPOSITORY_URI:build-$CLEAN_TAG"

  post_build:
    commands:
      - echo "â¬†ï¸ Subiendo a ECR..."
      # ðŸ›¡ï¸ FIX YAML: Comillas en los push
      - "docker push $REPOSITORY_URI:$IMAGE_TAG"
      - "docker push $REPOSITORY_URI:build-$CLEAN_TAG"
      
      - echo "ðŸ”„ Actualizando Lambdas..."
      - "aws lambda update-function-code --function-name $LAMBDA_BOT_NAME --image-uri $REPOSITORY_URI:$IMAGE_TAG > /dev/null"
      - "aws lambda update-function-code --function-name $LAMBDA_SCHEDULER_NAME --image-uri $REPOSITORY_URI:$IMAGE_TAG > /dev/null"
      
      - echo "âœ… Despliegue DOBLE completado."
