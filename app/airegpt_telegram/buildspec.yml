version: 0.2

env:
  variables:
    # ðŸ†• CAMBIO 1: Usamos un nombre de repo genÃ©rico para el "Core"
    ECR_REPO_NAME: "smability-telegram-core"
    
    # ðŸ†• CAMBIO 2: Definimos AMBAS funciones Lambda
    LAMBDA_BOT_NAME: "Smability-Chatbot"
    LAMBDA_SCHEDULER_NAME: "Smability-Scheduler"
    
    AWS_REGION: "us-east-1"

phases:
  pre_build:
    commands:
      - echo "ðŸ¤– Iniciando Build UNIFICADO (Bot + Scheduler)..."
      
      - echo "ðŸ†” Obteniendo Account ID..."
      - export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
      
      - echo "ðŸ”‘ Logueando en ECR..."
      - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com
      - REPOSITORY_URI=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO_NAME
      - IMAGE_TAG=latest

      # ðŸ†• CAMBIO 3: Copiamos la dependencia de API Light
      # (Como CodeBuild corre desde la raÃ­z, esta ruta funciona perfecto)
      - echo "ðŸ”„ Sincronizando API Light..."
      - cp api_light/lambda_function.py app/airegpt_telegram/lambda_api_light.py
      - echo "âœ… Dependencia copiada."

  build:
    commands:
      - echo "ðŸ“‚ Entrando a carpeta del mÃ³dulo..."
      - cd app/airegpt_telegram
      
      - echo "ðŸ³ Construyendo Docker Maestro..."
      - docker build -t $REPOSITORY_URI:$IMAGE_TAG .
      # Tag extra con el ID del build para tener historial
      - docker tag $REPOSITORY_URI:$IMAGE_TAG $REPOSITORY_URI:build-$CODEBUILD_BUILD_ID

  post_build:
    commands:
      - echo "â¬†ï¸ Subiendo a ECR..."
      - docker push $REPOSITORY_URI:$IMAGE_TAG
      - docker push $REPOSITORY_URI:build-$CODEBUILD_BUILD_ID
      
      # ðŸ†• CAMBIO 4: Actualizamos EL BOT
      - echo "ðŸ”„ Actualizando Lambda BOT ($LAMBDA_BOT_NAME)..."
      - aws lambda update-function-code --function-name $LAMBDA_BOT_NAME --image-uri $REPOSITORY_URI:$IMAGE_TAG > /dev/null
      
      # ðŸ†• CAMBIO 5: Actualizamos EL SCHEDULER (Con la misma imagen)
      - echo "ðŸ”„ Actualizando Lambda SCHEDULER ($LAMBDA_SCHEDULER_NAME)..."
      - aws lambda update-function-code --function-name $LAMBDA_SCHEDULER_NAME --image-uri $REPOSITORY_URI:$IMAGE_TAG > /dev/null
      
      - echo "âœ… Despliegue DOBLE completado exitosamente."
