<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smability AireGPT Model - CDMX</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; background: #0f172a; font-family: 'Inter', sans-serif; color: #e2e8f0; overflow: hidden; }
        #map { height: 100vh; width: 100%; background: #191a1a; z-index: 1; }
        
        .sidebar {
            position: absolute; top: 10px; left: 10px; z-index: 2000;
            background: rgba(15, 23, 42, 0.95); width: 320px;
            border-radius: 12px; border: 1px solid rgba(56, 189, 248, 0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.6); backdrop-filter: blur(10px);
            display: flex; flex-direction: column; overflow: hidden;
            transition: transform 0.3s ease, height 0.3s ease;
            max-height: 90vh;
        }
        .sidebar.collapsed { height: 60px; overflow: hidden; }

        .header { padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); background: linear-gradient(to right, rgba(56,189,248,0.1), transparent); display: flex; justify-content: space-between; align-items: center; }
        .title-group h1 { margin: 0; font-size: 18px; font-weight: 600; color: #38bdf8; letter-spacing: -0.5px; }
        .title-group .subtitle { font-size: 11px; color: #94a3b8; margin-top: 2px; text-transform: uppercase; letter-spacing: 1px; }
        .toggle-btn { background: none; border: none; color: #fff; font-size: 20px; cursor: pointer; padding: 5px; outline: none; }

        .time-controls { padding: 12px 20px; background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .time-select { width: 100%; padding: 8px 10px; background: #1e293b; color: #fff; border: 1px solid #475569; border-radius: 6px; font-size: 12px; font-family: 'Roboto Mono', monospace; cursor: pointer; outline: none; appearance: none; }
        
        .scroll-content { overflow-y: auto; flex: 1; padding-bottom: 10px; }
        .status-bar { padding: 8px 20px; font-size: 10px; color: #fff; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; background: rgba(0,0,0,0.2); }
        .live-dot { height: 6px; width: 6px; background-color: #22c55e; border-radius: 50%; display: inline-block; margin-right: 6px; box-shadow: 0 0 6px #22c55e; animation: pulse 2s infinite; }
        
        .controls { padding: 15px 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-var { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #94a3b8; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 11px; text-align: center; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 4px; font-weight: 500; }
        .btn-var:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-var.active { background: rgba(56, 189, 248, 0.15); border-color: #38bdf8; color: #fff; font-weight: 600; }

        .legend-panel { padding: 5px 20px 20px 20px; }
        .legend-title { font-size: 11px; color: #e2e8f0; margin-bottom: 10px; display: flex; justify-content: space-between; font-weight: 500; }
        .legend-bar { height: 8px; border-radius: 4px; position: relative; margin-bottom: 8px; }
        .legend-labels { display: flex; justify-content: space-between; font-size: 9px; color: #64748b; font-family: 'Roboto Mono'; }
        .stats-row { display: flex; justify-content: space-between; margin-top: 15px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); }
        .stat-item { text-align: center; }
        .stat-val { display: block; font-size: 14px; font-weight: 600; color: #fff; font-family: 'Roboto Mono'; margin-bottom: 2px; }
        .stat-lbl { font-size: 8px; color: #64748b; text-transform: uppercase; }

        #loading { text-align:center; padding:30px; color:#94a3b8; font-size: 12px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .spinner { width: 20px; height: 20px; border: 2px solid rgba(56,189,248,0.3); border-top: 2px solid #38bdf8; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        @media (max-width: 600px) { .sidebar { width: calc(100% - 20px); max-height: 65vh; } }
        .leaflet-popup-content-wrapper { background: #ffffff !important; color: #1e293b !important; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); border: none; padding: 0; }
        .leaflet-popup-tip { background: #ffffff !important; }
        .leaflet-popup-content { margin: 24px 16px 16px 16px; line-height: 1.5; }

        .leaflet-interactive {
            shape-rendering: crispEdges;
            stroke: none;
            stroke-width: 0;
            outline: none !important;
        }
        
        /* Excepci√≥n: Permitir que las estaciones mantengan su borde blanco */
        .leaflet-interactive[stroke="#ffffff"], 
        .leaflet-interactive[stroke="white"] {
            stroke: #ffffff !important;
            stroke-width: 2px !important;
            stroke-opacity: 1 !important;
            shape-rendering: auto; /* Para que el c√≠rculo de la estaci√≥n se vea suave/redondo */
        }
        
        .leaflet-canvas-layer {
            shape-rendering: crispEdges;
        }
        /* Ataca directamente al canvas de Mapbox/Leaflet */
        .leaflet-canvas-layer canvas, 
        canvas.leaflet-zoom-animated {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: pixelated; /* <--- Esto hace que los cuadros encajen perfecto */
        }      
        
        /* Asegura que los patentes de Leaflet no tengan borde */
        .leaflet-interactive {
            stroke-width: 0 !important;
            stroke-opacity: 0 !important;
            outline: none !important;
        }

        /* --- FOOTER SLIDER CONTAINER --- */
        .footer-controls {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            width: 90%;
            max-width: 800px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 100px; /* Estilo p√≠ldora moderno */
            border: 1px solid rgba(56, 189, 248, 0.3);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .play-btn {
            background: #38bdf8;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            color: #0f172a;
            font-size: 16px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .slider-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .modern-range {
            width: 100%;
            cursor: pointer;
            accent-color: #38bdf8;
            margin: 0;
        }
        
        #time-display {
            font-family: 'Roboto Mono', monospace;
            font-size: 11px;
            color: #38bdf8;
            text-align: center;
            margin-top: 4px;
            font-weight: 500;
        }
        
        @media (max-width: 600px) {
            .footer-controls { width: 95%; bottom: 15px; padding: 10px 15px; }
        }

        /* Nuevo estilo para el enlace de marca */
        .link-brand {
            display: block;
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-decoration: none;
            margin-top: 2px;
            transition: color 0.2s ease;
        }
        
        .link-brand:hover {
            color: #38bdf8; /* Azul cyan al pasar el mouse */
            text-decoration: none;
        }

        .leaflet-interactive {
            transition: fill-opacity 0.2s ease, stroke-opacity 0.2s ease, stroke-width 0.1s ease;
        }
                     
    </style>
</head>
<body>

    <div class="sidebar" id="sidebar">
        <div class="header">
            <div class="title-group">
                <div style="display:flex; align-items:center; gap:8px;">
                    <h1 style="margin:0; font-size:18px; font-weight:600; color:#38bdf8; letter-spacing:-0.5px;">AireGPT</h1>
                    
                    <a href="https://t.me/airegptcdmx_bot" target="_blank" title="Abrir Bot en Telegram" style="display:flex; align-items:center; justify-content:center; background:#229ED9; width:24px; height:24px; border-radius:50%; text-decoration:none; transition: transform 0.2s;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20.665 3.717L2.33 10.793C1.08 11.295 1.085 11.993 2.103 12.305L6.8 13.775L17.68 6.905C18.195 6.593 18.665 6.763 18.28 7.105L9.47 15.055L9.46 15.058L9.135 19.95C9.615 19.95 9.825 19.73 10.095 19.47L12.485 17.145L17.455 20.815C18.37 21.32 19.03 21.06 19.255 19.965L22.525 4.57C22.86 3.23 22.015 2.62 20.665 3.717Z" fill="white"/>
                        </svg>
                    </a>
                </div>
                <a href="https://smability.io" target="_blank" class="subtitle link-brand">
                    Smability.io
                </a>
            </div>
            <button class="toggle-btn" onclick="toggleSidebar()">‚ò∞</button>
        </div>
        
        <div class="time-controls">
            <select id="time-select" class="time-select" onchange="changeTime()">
                <option value="latest" selected>üî¥ En Vivo (Cargando...)</option>
            </select>
        </div>

        <div class="scroll-content">
            <div class="status-bar">
                <span><span class="live-dot" id="dot-indicator"></span><span id="connection-status">CONECTANDO...</span></span>
                <span id="update-time" style="font-family:'Roboto Mono'">--:--</span>
            </div>

            <div id="loading">
                <div class="spinner"></div>
                <div>Cargando datos...</div>
            </div>

            <div id="main-content" style="display:none;">
                <div class="controls">
                    <div class="btn-var btn-air active" id="btn-ias" onclick="setMode('ias', this)">üö¶ IAS</div>
                    <div class="btn-var btn-air" onclick="setMode('o3', this)">üî¥ O3</div>
                    <div class="btn-var btn-air" onclick="setMode('pm10', this)">üü§ PM10</div>
                    <div class="btn-var btn-air" onclick="setMode('pm25', this)">üü£ PM2.5</div>
                    <div class="btn-var btn-air" onclick="setMode('co', this)">üîµ CO</div>
                    <div class="btn-var btn-air" onclick="setMode('so2', this)">üü° SO2</div>
                    <div class="btn-var" onclick="setMode('tmp', this)">üå°Ô∏è Temp</div>
                    <div class="btn-var" onclick="setMode('rh', this)">üíß Hum</div>
                    <div class="btn-var" onclick="setMode('wsp', this)">üí® Viento</div>
                    <div class="btn-var" onclick="setMode('wdr', this)">üß≠ Dir.</div>
                    <div class="btn-var" style="grid-column: span 1;" onclick="setMode('alt', this)">‚õ∞Ô∏è Alt</div>
                    <div class="btn-var" style="grid-column: span 1;" onclick="setMode('building_vol', this)">üèôÔ∏è Urbano</div>
                </div>

                <div class="legend-panel">
                    <div class="legend-title">
                        <span id="legend-name">√çndice Aire y Salud</span>
                        <span id="legend-unit" style="color: #64748b;">Pts</span>
                    </div>
                    <div class="legend-bar" id="color-bar"></div>
                    <div class="legend-labels" id="legend-ticks"></div>

                    <div class="stats-row">
                        <div class="stat-item"><span class="stat-val" id="stat-min">--</span><span class="stat-lbl">M√≠nimo</span></div>
                        <div class="stat-item"><span class="stat-val" id="stat-avg">--</span><span class="stat-lbl">Promedio</span></div>
                        <div class="stat-item"><span class="stat-val" id="stat-max">--</span><span class="stat-lbl">M√°ximo</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer-controls">
        <button id="play-btn" class="play-btn">‚ñ∂</button>
        <div class="slider-wrapper">
            <input type="range" id="time-slider" min="0" max="24" value="24" class="modern-range">
            <div id="time-display">üî¥ EN VIVO</div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        const BASE_API_URL = "https://vuy3dprsp2udtuelnrb5leg6ay0ygsky.lambda-url.us-east-1.on.aws/";

        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    
    <script>
      
        // 1. INICIALIZAR MAPA
        const BASE_API_URL = "https://vuy3dprsp2udtuelnrb5leg6ay0ygsky.lambda-url.us-east-1.on.aws/";
        const MAPBOX_TOKEN = 'pk.eyJ1Ijoia2lsb2JhdG8iLCJhIjoiY21rYnJseG1kMDZnczNlb2xrdDhrejE1biJ9.VFEMLEntTg5fDXDefQTnFA';

        // 1. INICIALIZAR MAPA
        const map = L.map('map', { 
            zoomControl: false, 
            preferCanvas: true,
            renderer: L.canvas({ padding: 0.5 }) 
        });

        // 2. ZOOM AJUSTADO (TIGHT FIT)
        map.fitBounds([
            [19.10, -99.35], // Suroeste
            [19.75, -98.85]  // Noreste
        ]);
        
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // --- DEFINICI√ìN DE CAPAS (S√ÅNDWICH PRO) ---
        
        // Nivel 1: Fondo S√≥lido (Abajo)
        map.createPane('basePane');   
        map.getPane('basePane').style.zIndex = 200;

        // Nivel 2: Tu Modelo de Aire (En medio)
        map.createPane('gridPane');   
        map.getPane('gridPane').style.zIndex = 400;

        // Nivel 3: Tu Overlay Fantasma (Arriba)
        map.createPane('labelsPane');
        map.getPane('labelsPane').style.zIndex = 600;
        map.getPane('labelsPane').style.pointerEvents = 'none'; // ¬°Vital para dar clic al grid!

        // --- CARGAR LOS MAPAS ---

        // A. FONDO: CARTO DARK NO LABELS (Negro Puro y Mudo)
        // Usamos este porque NO trae calles, as√≠ evitamos el efecto "doble visi√≥n"
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
            pane: 'basePane', 
            opacity: 1,
            maxZoom: 19,
            attribution: '¬© OpenStreetMap, ¬© CARTO'
        }).addTo(map);

        // B. TU OVERLAY PERSONALIZADO (Tus calles controladas)
        // Nota: Mantenemos tu estilo. Cuando quieras quitar lo rojo, borra "&test=rojo"
        const labelsLayer = L.tileLayer(`https://api.mapbox.com/styles/v1/kilobato/cmkm0j41j009001rz6opkd82a/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}&test=gris`, {
            pane: 'labelsPane', 
            opacity: 1, 
            tileSize: 512, zoomOffset: -1, maxZoom: 19
        }).addTo(map);
        
        // Filtro opcional por si el rojo/blanco brilla demasiado
        labelsLayer.getContainer().style.filter = "brightness(0.9)";
        
        const CONFIG = {
            ias: { name: '√çndice Aire y Salud', unit: 'Pts', min: 0, max: 200, stops: [0, 50, 100, 150, 200, 300], colors: ['#00e400', '#ffff00', '#ff7e00', '#ff0000', '#8f3f97', '#7e0023'] },
            o3: { name: 'Ozono (O3)', unit: 'ppb', min: 0, max: 200, stops: [0, 50, 100, 150, 200, 250], colors: ['#00e400', '#ffff00', '#ff7e00', '#ff0000', '#8f3f97', '#7e0023'] },
            pm10: { name: 'Part√≠culas PM10', unit: '¬µg/m¬≥', min: 0, max: 215, stops: [0, 45, 75, 130, 215, 300], colors: ['#00e400', '#ffff00', '#ff7e00', '#ff0000', '#8f3f97', '#7e0023'] },
            pm25: { name: 'Part√≠culas PM2.5', unit: '¬µg/m¬≥', min: 0, max: 150, stops: [0, 25, 45, 80, 147, 200], colors: ['#00e400', '#ffff00', '#ff7e00', '#ff0000', '#8f3f97', '#7e0023'] },
            // --- NUEVOS GASES ---
            co: { name: 'Mon√≥xido Carbono', unit: 'ppm', min: 0, max: 15, stops: [0, 9, 11, 13, 15, 20], colors: ['#00e400', '#ffff00', '#ff7e00', '#ff0000', '#8f3f97', '#7e0023'] },
            so2: { name: 'Di√≥xido Azufre', unit: 'ppb', min: 0, max: 200, stops: [0, 40, 75, 185, 300, 500], colors: ['#00e400', '#ffff00', '#ff7e00', '#ff0000', '#8f3f97', '#7e0023'] },
            // --------------------
            tmp: { name: 'Temperatura', unit: '¬∞C', min: 0, max: 35, stops: [0, 10, 20, 30, 35], colors: ['#0000ff', '#00ffff', '#ffff00', '#ff0000', '#800000'] },
            rh: { name: 'Humedad', unit: '%', min: 0, max: 100, stops: [0, 25, 50, 75, 100], colors: ['#8d6e63', '#a5d6a7', '#4dd0e1', '#0288d1', '#01579b'] },
            wsp: { name: 'Viento', unit: 'm/s', min: 0, max: 15, stops: [0, 3, 6, 9, 15], colors: ['#ffffff', '#b3e5fc', '#29b6f6', '#0277bd', '#4a148c'] },
            // NUEVO CONFIG PARA DIRECCI√ìN (0¬∞=N, 90¬∞=E, 180¬∞=S, 270¬∞=O)
            wdr: { name: 'Dir. Viento', unit: '¬∞', min: 0, max: 360, stops: [0, 90, 180, 270, 360], colors: ['#ff0000', '#ffff00', '#00ff00', '#0000ff', '#ff0000'] },
            alt: { name: 'Altitud', unit: 'm', min: 2230, max: 4000, stops: [2230, 2260, 2400, 2900, 3500, 4000], colors: ['#0d47a1', '#1b5e20', '#8bc34a', '#fbc02d', '#795548', '#eeeeee'] },
            building_vol: { name: 'Densidad Urbana', unit: 'm¬≥', min: 0, max: 1200000, stops: [0, 10000, 100000, 400000, 800000, 1200000], colors: ['#ffffff', '#e0e0e0', '#fca5a5', '#ef4444', '#b91c1c', '#7f1d1d'] }
        };

        let globalData = null;
        let fallbackData = null; 
        let currentMetric = 'ias'; 
        let geoLayer = null;

        console.log("üöÄ Iniciando Dashboard V6.5 (Safe Time Parse)");
        generateLocalTimeOptions();
        loadMapData('latest');

        function generateLocalTimeOptions() {
            const select = document.getElementById('time-select');
            select.innerHTML = ''; 
            const optLatest = document.createElement('option');
            optLatest.value = 'latest'; optLatest.innerText = "üî¥ En Vivo (Cargando...)";
            select.appendChild(optLatest);

            const now = new Date();
            let start = new Date(now);
            if (start.getMinutes() < 20) start.setHours(start.getHours() - 1);
            start.setMinutes(20); start.setSeconds(0);

            for (let i = 0; i < 24; i++) {
                const d = new Date(start.getTime() - (i * 60 * 60 * 1000));
                const year = d.getFullYear(); const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0'); const hour = String(d.getHours()).padStart(2, '0');
                const min = String(d.getMinutes()).padStart(2, '0');
                const val = `${year}-${month}-${day}_${hour}-${min}`;
                const label = `${day}/${month} - ${hour}:${min}`;
                const opt = document.createElement('option');
                opt.value = val; opt.innerText = label;
                select.appendChild(opt);
            }
        }

        // --- VINCULACI√ìN DEL SLIDER ---
        const timeSlider = document.getElementById('time-slider');
        const timeDisplay = document.getElementById('time-display');
        const timeSelect = document.getElementById('time-select'); // Mantenemos el select oculto como puente
        
        timeSlider.addEventListener('input', (e) => {
            const val = parseInt(e.target.value);
            const options = timeSelect.options;
            
            // Invertimos el √≠ndice porque el slider 24 es "latest" (√≠ndice 0)
            const index = options.length - 1 - val;
            const selectedOption = options[index];
            
            timeSelect.selectedIndex = index;
            timeDisplay.innerText = selectedOption.text;
            
            // Si es el valor m√°ximo, ponemos el punto rojo de "En Vivo"
            if (val == 24) {
                timeDisplay.innerHTML = `<span class="live-dot"></span> EN VIVO`;
            }
        
            // Disparar carga de datos
            loadMapData(selectedOption.value);
        });
        
        // --- [INICIO ANCLA A: L√ìGICA PLAY/PAUSE OPTIMIZADA] ---
        let isPlaying = false;
        let playInterval;
        
        document.getElementById('play-btn').addEventListener('click', function() {
            // 1. COLAPSAR MEN√ö AUTOM√ÅTICAMENTE
            // Asumimos que tu sidebar tiene el ID 'sidebar' y se colapsa con la clase 'collapsed'
            const sidebar = document.getElementById('sidebar');
            if (sidebar && !sidebar.classList.contains('collapsed')) {
                // Si tienes una funci√≥n toggleSidebar() definida arriba, la llamamos:
                if (typeof toggleSidebar === "function") {
                    toggleSidebar();
                } else {
                    // Si no, forzamos la clase directamente
                    sidebar.classList.add('collapsed');
                }
            }
        
            isPlaying = !isPlaying;
            this.innerText = isPlaying ? "‚è∏" : "‚ñ∂";
            
            if (isPlaying) {
                // Si el usuario da PLAY y el slider est√° en el final (24), reiniciamos al 0
                if (parseInt(timeSlider.value) >= 24) {
                    timeSlider.value = 0;
                    timeSlider.dispatchEvent(new Event('input'));
                }
        
                playInterval = setInterval(() => {
                    let nextVal = parseInt(timeSlider.value) + 1;
                    
                    if (nextVal > 24) {
                        // --- DETENER LOOP AL LLEGAR AL FINAL ---
                        clearInterval(playInterval);
                        isPlaying = false;
                        this.innerText = "‚ñ∂";
                        console.log("üèÅ Ciclo completado.");
                    } else {
                        timeSlider.value = nextVal;
                        // Disparamos el evento 'input' para que cargue el mapa
                        timeSlider.dispatchEvent(new Event('input'));
                    }
                }, 1800); // 1.8 segundos para dar tiempo a la transici√≥n de Mapbox
            } else {
                clearInterval(playInterval);
            }
        });
        // --- [FIN ANCLA B] ---

        function loadMapData(forceTimestamp = null) {
            const select = document.getElementById('time-select');
            const timestampKey = forceTimestamp || select.value;

            document.getElementById('loading').style.display = 'flex';
            document.getElementById('main-content').style.opacity = '0.3';
            
            let url = BASE_API_URL + "?mode=map";
            if (timestampKey !== 'latest') { url += `&timestamp=${timestampKey}`; }
            url += `&_t=${Date.now()}`;

            fetch(url)
                .then(response => { if(!response.ok) throw new Error("Datos no encontrados"); return response.json(); })
                .then(data => {
                    // --- [ADAPTADOR DE LLAVES JSON] ---
                    // Como el JSON ahora trae espacios ("o3 1h"), los mapeamos a variables simples
                    // para que el resto del c√≥digo (renderMap, popups, colores) no se rompa.
                    data.forEach(p => {
                        p.o3 = p['o3 1h'] || p.o3;
                        p.pm10 = p['pm10 12h'] || p.pm10;
                        p.pm25 = p['pm25 12h'] || p.pm25;
                        // NUEVOS MAPEOSS
                        p.co = p['co 8h'] || p.co;
                        p.so2 = p['so2 1h'] || p.so2;
                    });
                    // --- [FIN ADAPTADOR] ---
                    globalData = data;
                    if (timestampKey === 'latest') {
                        fallbackData = data; 
                        
                        // PARSING SEGURO DE FECHA (Sin timezone shift)
                        let timeStr = "--:--";
                        if(data.length > 0 && data[0].timestamp) {
                            // "2025-12-11 13:20:00" -> Cortamos los caracteres exactos
                            // [11, 16] extrae "13:20"
                            timeStr = data[0].timestamp.substring(11, 16);
                            
                            // Actualizar etiqueta del dropdown
                            const latOpt = select.querySelector('option[value="latest"]');
                            if(latOpt) latOpt.innerText = `üî¥ En Vivo - ${timeStr}`;
                            document.getElementById('update-time').innerText = timeStr;
                        }
                        
                        document.getElementById('connection-status').innerText = "EN VIVO";
                        document.getElementById('connection-status').style.color = "#22c55e";
                        document.getElementById('dot-indicator').style.backgroundColor = "#22c55e";
                        document.getElementById('dot-indicator').style.boxShadow = "0 0 6px #22c55e";
                    } else {
                        document.getElementById('connection-status').innerText = "HIST√ìRICO";
                        document.getElementById('connection-status').style.color = "#38bdf8";
                        document.getElementById('dot-indicator').style.backgroundColor = "#38bdf8";
                        document.getElementById('dot-indicator').style.boxShadow = "0 0 6px #38bdf8";
                        
                        if(data.length > 0 && data[0].timestamp) {
                            const ts = data[0].timestamp;
                            const timeStr = ts.substring(11, 16);
                            document.getElementById('update-time').innerText = timeStr;
                        }
                    }
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                    document.getElementById('main-content').style.opacity = '1';
                    renderMap();
                })
                .catch(err => {
                    console.error("Error carga:", err);
                    document.getElementById('loading').innerHTML = `<div style="color:#ef4444">Sin datos para esta hora.</div>`;
                });
        }

        function changeTime() { loadMapData(); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }

        function getColor(val, metric) {
            const conf = CONFIG[metric];
            let v = Number(val || 0);
            v = Math.max(conf.min, Math.min(v, conf.max));
            const stops = conf.stops;
            for (let i = 0; i < stops.length - 1; i++) {
                if (v >= stops[i] && v <= stops[i+1]) {
                    const t = (v - stops[i]) / (stops[i+1] - stops[i]);
                    const c1 = hexToRgb(conf.colors[i]);
                    const c2 = hexToRgb(conf.colors[i+1]);
                    return `rgb(${lerp(c1.r, c2.r, t)}, ${lerp(c1.g, c2.g, t)}, ${lerp(c1.b, c2.b, t)})`;
                }
            }
            return conf.colors[0];
        }

        function hexToRgb(hex) { const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : {r:0,g:0,b:0}; }
        function lerp(start, end, t) { return Math.round(start + (end - start) * t); }

        function renderMap() {
            if (!globalData) return;
            if (geoLayer) map.removeLayer(geoLayer);
            
            const conf = CONFIG[currentMetric]; 
            const RECT_SIZE = 0.005;
            const OVERLAP = 1.03;
            const rectangles = []; 
            const vals = [];

            let dataKey = currentMetric;
            if (currentMetric === 'alt') dataKey = 'altitude'; 

            for(let i=0; i < globalData.length; i++) {
                let p = globalData[i];
                let val = p[dataKey];
                
                if ((dataKey === 'altitude' || dataKey === 'building_vol') && (!val || val === 0)) {
                    if (fallbackData && fallbackData[i]) {
                        val = fallbackData[i][dataKey];
                    }
                }

                val = Number(val || 0);
                vals.push(val);

                const color = getColor(val, currentMetric);
                // Aplicamos el OVERLAP para que los cuadros se encimen sutilmente y borren la rejilla
                const bounds = [
                    [p.lat - (RECT_SIZE * OVERLAP), p.lon - (RECT_SIZE * OVERLAP)], 
                    [p.lat + (RECT_SIZE * OVERLAP), p.lon + (RECT_SIZE * OVERLAP)]
                ];
                const isStation = p.station ? true : false;
                const strokeColor = isStation ? '#ffffff' : color;
                const weight = isStation ? 2 : 0;
                const fillOp = isStation ? 0.9 : 0.65;
                const rect = L.rectangle(bounds, {
                        pane: 'gridPane',
                        stroke: isStation,      // <--- S√öPER IMPORTANTE: False para la IA
                        color: '#ffffff', 
                        weight: isStation ? 2 : 0, 
                        fillOpacity: fillOp, 
                        fillColor: color,
                        interactive: true
                    });

                const riskColor = (p.risk === 'Alto' || p.risk === 'Muy Alto' || p.risk === 'Extremadamente Alto') ? '#ef4444' : (p.risk === 'Moderado' ? '#eab308' : '#22c55e');
                // --- [INICIO NUEVA L√ìGICA DE UBICACI√ìN Y POBLACI√ìN] ---
                
                // 1. Formateador de Poblaci√≥n (4383 -> 4.4k)
                const fmtPob = (n) => {
                    if (!n || n === 0) return '';
                    if (n >= 1000) return `üë• ${(n/1000).toFixed(1)}k`;
                    return `üë• ${n}`;
                };

                // 2. L√≥gica de T√≠tulo de Ubicaci√≥n Inteligente
                let loc_text = `üìç ${p.lat.toFixed(2)}, ${p.lon.toFixed(2)}`; // Default
                
                if (p.col && p.col !== 'Zona Federal / Sin Colonia') {
                    // Caso Ideal: Tenemos Colonia
                    loc_text = `üìç ${p.col}, ${p.mun}`;
                } else if (p.mun && p.mun !== 'Valle de M√©xico' && p.mun !== 'ZMVM') {
                    // Caso Respaldo: Solo Municipio
                    loc_text = `üìç ${p.mun}, ${p.edo || ''}`;
                }

                // 3. Cadena de Poblaci√≥n
                const pob_text = fmtPob(p.pob);
                // --- [FIN L√ìGICA] ---
                
                // --- [INICIO FUSI√ìN: DISE√ëO ORIGINAL + FUENTES] ---
                let bVol = Number(p.building_vol || 0);
                let altVal = Number(p.altitude || 0);
                // Fallback para datos faltantes en malla
                if (bVol === 0 && fallbackData && fallbackData[i]) bVol = Number(fallbackData[i].building_vol || 0);
                if (altVal === 0 && fallbackData && fallbackData[i]) altVal = Number(fallbackData[i].altitude || 0);

                let headerHTML = `<div style="font-size:10px; color:#64748b; text-align:right; margin-bottom:4px; font-weight:600;">üïí ${p.timestamp || 'Live'}</div>`;
                if (isStation) { headerHTML += `<div style="background:#38bdf8; color:#0f172a; padding:4px 8px; border-radius:4px; margin-bottom:8px; text-align:center; font-weight:bold; font-size:12px;">üì° Estaci√≥n: ${p.station}</div>`; }

                // 1. L√ìGICA DE FUENTES (NUEVO)
                let sourcesObj = {};
                try { if (p.sources) sourcesObj = JSON.parse(p.sources); } catch (e) {}

                const fmtSrc = (pol) => {
                    let src = sourcesObj[pol];
                    
                    // Si no existe fuente, asumimos IA (sin agregar tiempo, para no ser redundantes)
                    if (!src) src = "IA";

                    // TRUCO DE LIMPIEZA: Quitamos " 1h" o " 12h" del string
                    // Ejemplo: "Oficial 12h" -> "Oficial"
                    let displayLabel = src.replace(" 1h", "").replace(" 12h", "").replace(" 8h", "");

                    const isIA = displayLabel.includes("IA");
                    const color = isIA ? '#94a3b8' : '#0ea5e9'; 
                    const weight = isIA ? '400' : '700';

                    return `<span style="font-size:0.7em; color:${color}; margin-left:3px; font-weight:${weight}; display:inline-block; vertical-align:middle;">
                                (${displayLabel})
                            </span>`;
                };

                // 4. POPUP ACTUALIZADO
                rect.bindPopup(`
                    <div style="font-family:'Inter'; color:#334155; min-width: 195px;">
                        ${headerHTML}
                        
                        <div style="margin-bottom:8px; border-bottom:1px solid #e2e8f0; padding-bottom:4px;">
                            <div style="font-size:11px; font-weight:700; color:#3b82f6; margin-bottom:1px;">
                                ${loc_text}
                            </div>
                            ${pob_text ? `<div style="font-size:10px; color:#64748b;">${pob_text} habitantes</div>` : ''}
                        </div>
                        
                        <div style="display:grid; grid-template-columns: auto 1fr; gap: 4px 10px; font-size:12px; align-items: center;">
                            
                            <span style="font-weight:600; color:#000;">üö¶ IAS:</span> 
                            <span style="font-weight:bold;">${Number(p.ias||0).toFixed(0)} pts</span>
                            
                            <span style="font-weight:600; color:#000;">‚ò¢Ô∏è Riesgo:</span> 
                            <span style="font-weight:bold; color:${riskColor};">${p.risk || 'N/A'}</span>
                            
                            <span style="font-weight:600; color:#000; white-space:nowrap;">
                                üî¥ O3 <span style="font-size:9px; color:#64748b;">(1h)</span>${p.dominant === 'O3' ? ' <b style="color:#ef4444;">(Dom)</b>' : ''}:
                            </span> 
                            <span style="white-space:nowrap;">
                                ${Number(p.o3||0).toFixed(1)} ppb ${fmtSrc('o3')}
                            </span>
                            
                            <span style="font-weight:600; color:#000; white-space:nowrap;">
                                üü§ PM10 <span style="font-size:9px; color:#64748b;">(12h)</span>${p.dominant === 'PM10' ? ' <b style="color:#a855f7;">(Dom)</b>' : ''}:
                            </span> 
                            <span style="white-space:nowrap;">
                                ${Number(p.pm10||0).toFixed(1)} ¬µg ${fmtSrc('pm10')}
                            </span>
                            
                            <span style="font-weight:600; color:#000; white-space:nowrap;">
                                üü£ PM2.5 <span style="font-size:9px; color:#64748b;">(12h)</span>${p.dominant === 'PM2.5' ? ' <b style="color:#a855f7;">(Dom)</b>' : ''}:
                            </span> 
                            <span style="white-space:nowrap;">
                                ${Number(p.pm25||0).toFixed(1)} ¬µg ${fmtSrc('pm25')}
                            </span>

                            <span style="font-weight:600; color:#000; white-space:nowrap;">
                                üîµ CO <span style="font-size:9px; color:#64748b;">(8h)</span>:
                            </span> 
                            <span style="white-space:nowrap;">
                                ${Number(p.co||0).toFixed(2)} ppm ${fmtSrc('co')}
                            </span>

                            <span style="font-weight:600; color:#000; white-space:nowrap;">
                                üü° SO2 <span style="font-size:9px; color:#64748b;">(1h)</span>:
                            </span>
                            
                            <span style="white-space:nowrap;">
                                ${Number(p.so2||0).toFixed(1)} ppb ${fmtSrc('so2')}
                            </span>

                            <hr style="grid-column: span 2; border:0; border-top:1px solid #e2e8f0; width:100%; margin:4px 0;">
                            
                            <span style="color:#475569;">üèôÔ∏è Vol:</span> 
                            <span>${(bVol/1000).toFixed(0)}k m¬≥</span>

                            <span style="color:#475569;">üå°Ô∏è Temp:</span> 
                            <span style="white-space:nowrap;">
                                ${Number(p.tmp||0).toFixed(1)} ¬∞C ${fmtSrc('tmp')}
                            </span>

                            <span style="color:#475569;">üíß Hum:</span> 
                            <span style="white-space:nowrap;">
                                ${Number(p.rh||0).toFixed(0)} % ${fmtSrc('rh')}
                            </span>

                            <span style="color:#475569;">üí® Viento:</span> 
                            <span style="white-space:nowrap;">
                                ${Number(p.wsp||0).toFixed(1)} m/s ${fmtSrc('wsp')}
                            </span>

                            <span style="color:#475569;">üß≠ Dir:</span> 
                            <span style="white-space:nowrap;">
                                ${Number(p.wdr||0).toFixed(0)}¬∞ ${fmtSrc('wdr')}
                            </span>

                            <span style="color:#475569;">‚õ∞Ô∏è Alt:</span> 
                            <span>${altVal.toFixed(0)} m</span>
                        </div>
                    </div>
                `);
                // --- [FIN POPUP] ---
                
                // --- INICIO EFECTO FOCUS (HOVER) ---
                rect.on('mouseover', function() {
                    this.setStyle({ 
                        fillOpacity: 0.9,
                        // L√≥gica: Si es estaci√≥n, borde grueso (4). Si es grid normal, borde fino (1)
                        weight: isStation ? 4 : 1, 
                        // Color: Estaci√≥n = blanco puro. Grid = blanco semi-transparente
                        color: isStation ? '#ffffff' : 'rgba(255, 255, 255, 0.5)', 
                        stroke: true 
                    });
                    
                    // Truco vital: Traer el cuadro al frente para que el borde no lo tapen los vecinos
                    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                        this.bringToFront();
                    }
                });

                rect.on('mouseout', function() {
                    this.setStyle({ 
                        fillOpacity: fillOp,
                        // Restauramos estado original:
                        // Estaci√≥n = borde 2. Grid = borde 0 (invisible)
                        weight: isStation ? 2 : 0,
                        stroke: isStation,
                        color: '#ffffff'
                    });
                });
                // --- FIN EFECTO FOCUS ---
                rectangles.push(rect);
            }
            geoLayer = L.layerGroup(rectangles).addTo(map);
            if (vals.length > 0) updateLegend(conf, Math.min(...vals), Math.max(...vals), vals.reduce((a,b)=>a+b,0)/vals.length);
        }

        function updateLegend(conf, min, max, avg) {
            document.getElementById('legend-name').innerText = conf.name;
            document.getElementById('legend-unit').innerText = conf.unit;
            let gradStr = 'linear-gradient(to right';
            for(let i=0; i<conf.stops.length; i++) {
                let pct = ((conf.stops[i] - conf.min) / (conf.max - conf.min)) * 100;
                gradStr += `, ${conf.colors[i]} ${pct}%`;
            }
            gradStr += ')';
            document.getElementById('color-bar').style.background = gradStr;
            document.getElementById('legend-ticks').innerHTML = conf.stops.map(s => `<span>${s}</span>`).join('');
            document.getElementById('stat-min').innerText = min.toFixed(1);
            document.getElementById('stat-max').innerText = max.toFixed(1);
            document.getElementById('stat-avg').innerText = avg.toFixed(1);
        }

        window.setMode = (mode, el) => {
            currentMetric = mode;
            document.querySelectorAll('.btn-var').forEach(b => b.classList.remove('active'));
            if(el) el.classList.add('active');
            renderMap();
        };
        // --- COPIAR DESDE AQU√ç ---
        function scheduleNextUpdate() {
            const now = new Date();
            const nextUpdate = new Date(now);
        
            // Si ya pasamos el minuto 20 de esta hora, programamos para la siguiente hora
            if (now.getMinutes() >= 20) {
                nextUpdate.setHours(now.getHours() + 1);
            }
            
            nextUpdate.setMinutes(20);
            nextUpdate.setSeconds(20);
            nextUpdate.setMilliseconds(0);
        
            const msUntilUpdate = nextUpdate.getTime() - now.getTime();
            
            console.log(`üîÑ Pr√≥xima actualizaci√≥n en: ${(msUntilUpdate / 1000 / 60).toFixed(1)} min`);
        
            setTimeout(() => {
                console.log("üöÄ Ejecutando Auto-Refresh Programado...");
                loadMapData('latest'); 
                generateLocalTimeOptions(); 
                scheduleNextUpdate(); // Re-ciclar
            }, msUntilUpdate);
        }
        scheduleNextUpdate();
        // --- HASTA AQU√ç ---
    </script>
</body>
</html>
