<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smability AireGPT Model - CDMX</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; background: #0f172a; font-family: 'Inter', sans-serif; color: #e2e8f0; overflow: hidden; }
        #map { height: 100vh; width: 100%; background: #191a1a; z-index: 1; }
        
        .sidebar {
            position: absolute; top: 10px; left: 10px; z-index: 2000;
            background: rgba(15, 23, 42, 0.95); width: 320px;
            border-radius: 12px; border: 1px solid rgba(56, 189, 248, 0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.6); backdrop-filter: blur(10px);
            display: flex; flex-direction: column; overflow: hidden;
            transition: transform 0.3s ease, height 0.3s ease;
            max-height: 90vh;
        }
        .sidebar.collapsed { height: 60px; overflow: hidden; }

        .header { padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); background: linear-gradient(to right, rgba(56,189,248,0.1), transparent); display: flex; justify-content: space-between; align-items: center; }
        .title-group h1 { margin: 0; font-size: 18px; font-weight: 600; color: #38bdf8; letter-spacing: -0.5px; }
        .title-group .subtitle { font-size: 11px; color: #94a3b8; margin-top: 2px; text-transform: uppercase; letter-spacing: 1px; }
        /* Estilo para el Toggle de Idioma */
        .lang-toggle {
            font-size: 10px; color: #64748b; font-weight: 600; 
            margin-top: 4px; cursor: pointer; letter-spacing: 1px;
        }
        .lang-opt { transition: color 0.2s; }
        .lang-opt:hover { color: #fff; }
        .lang-opt.active { color: #38bdf8; text-decoration: underline; }
        .toggle-btn { background: none; border: none; color: #fff; font-size: 20px; cursor: pointer; padding: 5px; outline: none; }

        .time-controls { padding: 12px 20px; background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .time-select { width: 100%; padding: 8px 10px; background: #1e293b; color: #fff; border: 1px solid #475569; border-radius: 6px; font-size: 12px; font-family: 'Roboto Mono', monospace; cursor: pointer; outline: none; appearance: none; }
        
        .scroll-content { overflow-y: auto; flex: 1; padding-bottom: 10px; }
        .status-bar { padding: 8px 20px; font-size: 10px; color: #fff; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; background: rgba(0,0,0,0.2); }
        .live-dot { height: 6px; width: 6px; background-color: #22c55e; border-radius: 50%; display: inline-block; margin-right: 6px; box-shadow: 0 0 6px #22c55e; animation: pulse 2s infinite; }
        
        .controls { padding: 15px 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-var { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #94a3b8; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 11px; text-align: center; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 4px; font-weight: 500; }
        .btn-var:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-var.active { background: rgba(56, 189, 248, 0.15); border-color: #38bdf8; color: #fff; font-weight: 600; }

        .legend-panel { padding: 5px 20px 20px 20px; }
        .legend-title { font-size: 11px; color: #e2e8f0; margin-bottom: 10px; display: flex; justify-content: space-between; font-weight: 500; }
        .legend-bar { height: 8px; border-radius: 4px; position: relative; margin-bottom: 8px; }
        .legend-labels { display: flex; justify-content: space-between; font-size: 9px; color: #64748b; font-family: 'Roboto Mono'; }
        .stats-row { display: flex; justify-content: space-between; margin-top: 15px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); }
        .stat-item { text-align: center; }
        .stat-val { display: block; font-size: 14px; font-weight: 600; color: #fff; font-family: 'Roboto Mono'; margin-bottom: 2px; }
        .stat-lbl { font-size: 8px; color: #64748b; text-transform: uppercase; }

        #loading { text-align:center; padding:30px; color:#94a3b8; font-size: 12px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .spinner { width: 20px; height: 20px; border: 2px solid rgba(56,189,248,0.3); border-top: 2px solid #38bdf8; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        @media (max-width: 600px) { .sidebar { width: calc(100% - 20px); max-height: 65vh; } }
        .leaflet-popup-content-wrapper { background: #ffffff !important; color: #1e293b !important; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); border: none; padding: 0; }
        .leaflet-popup-tip { background: #ffffff !important; }
        .leaflet-popup-content { margin: 24px 16px 16px 16px; line-height: 1.5; }

        /* --- MANEJO DE BORDES (GHOST MODE) --- */
        .leaflet-interactive {
            shape-rendering: crispEdges;
            stroke: none;
            stroke-width: 0;
            outline: none !important;
            transition: fill-opacity 0.2s ease, stroke-opacity 0.2s ease, stroke-width 0.1s ease;
        }
        
        /* Excepci√≥n: Las estaciones s√≠ llevan borde blanco */
        .leaflet-interactive[stroke="#ffffff"], 
        .leaflet-interactive[stroke="white"] {
            stroke: #ffffff !important;
            stroke-width: 2px !important;
            stroke-opacity: 1 !important;
            shape-rendering: auto; 
        }
        
        .leaflet-canvas-layer canvas, 
        canvas.leaflet-zoom-animated {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: pixelated; 
        }      
        
        .footer-controls {
            position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%);
            z-index: 2000; width: 90%; max-width: 800px;
            background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px);
            padding: 12px 20px; border-radius: 100px;
            border: 1px solid rgba(56, 189, 248, 0.3);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex; align-items: center; gap: 15px;
        }
        
        .play-btn {
            background: #38bdf8; border: none; width: 35px; height: 35px;
            border-radius: 50%; cursor: pointer; color: #0f172a; font-size: 16px;
            flex-shrink: 0; display: flex; align-items: center; justify-content: center;
        }
        
        .slider-wrapper { flex-grow: 1; display: flex; flex-direction: column; }
        .modern-range { width: 100%; cursor: pointer; accent-color: #38bdf8; margin: 0; }
        
        #time-display {
            font-family: 'Roboto Mono', monospace; font-size: 11px;
            color: #38bdf8; text-align: center; margin-top: 4px; font-weight: 500;
        }
        
        @media (max-width: 600px) { .footer-controls { width: 95%; bottom: 15px; padding: 10px 15px; } }

        .link-brand {
            display: block; font-size: 11px; color: #94a3b8; text-transform: uppercase;
            letter-spacing: 1px; text-decoration: none; margin-top: 2px; transition: color 0.2s ease;
        }
        .link-brand:hover { color: #38bdf8; text-decoration: none; }

        .leaflet-interactive {
            transition: fill-opacity 0.2s ease, stroke-opacity 0.2s ease, stroke-width 0.1s ease;
        }
                     
    </style>
</head>
<body>

    <div class="sidebar" id="sidebar">
        <div class="header">
            <div class="title-group">
                <div style="display:flex; align-items:center; gap:8px;">
                    <h1 style="margin:0; font-size:18px; font-weight:600; color:#38bdf8; letter-spacing:-0.5px;">AireGPT</h1>
                    <a href="https://t.me/airegptcdmx_bot" target="_blank" title="Telegram Bot" style="display:flex; align-items:center; justify-content:center; background:#229ED9; width:24px; height:24px; border-radius:50%; text-decoration:none;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20.665 3.717L2.33 10.793C1.08 11.295 1.085 11.993 2.103 12.305L6.8 13.775L17.68 6.905C18.195 6.593 18.665 6.763 18.28 7.105L9.47 15.055L9.46 15.058L9.135 19.95C9.615 19.95 9.825 19.73 10.095 19.47L12.485 17.145L17.455 20.815C18.37 21.32 19.03 21.06 19.255 19.965L22.525 4.57C22.86 3.23 22.015 2.62 20.665 3.717Z" fill="white"/></svg>
                    </a>
                </div>
                <a href="https://smability.io" target="_blank" class="subtitle link-brand">Smability.io</a>
                
                <div class="lang-toggle">
                    <span onclick="setLang('es')" id="lang-es" class="lang-opt active">ES</span> | 
                    <span onclick="setLang('en')" id="lang-en" class="lang-opt">EN</span>
                </div>
            </div>
            <button class="toggle-btn" onclick="toggleSidebar()">‚ò∞</button>
        </div>
        
        <div class="time-controls">
            <select id="time-select" class="time-select" onchange="changeTime()">
                <option value="latest" selected>üî¥ En Vivo (Cargando...)</option>
            </select>
        </div>

        <div class="scroll-content">
            <div class="status-bar">
                <span><span class="live-dot" id="dot-indicator"></span><span id="connection-status">CONECTANDO...</span></span>
                <span id="update-time" style="font-family:'Roboto Mono'">--:--</span>
            </div>

            <div id="loading">
                <div class="spinner"></div>
                <div id="loading-text">Cargando datos...</div>
            </div>

            <div id="main-content" style="display:none;">
                <div class="controls">
                    <div class="btn-var btn-air active" id="btn-ias" onclick="setMode('ias', this)">üö¶ IAS</div>
                    <div class="btn-var btn-air" onclick="setMode('o3', this)">üî¥ O3</div>
                    <div class="btn-var btn-air" onclick="setMode('pm10', this)">üü§ PM10</div>
                    <div class="btn-var btn-air" onclick="setMode('pm25', this)">üü£ PM2.5</div>
                    <div class="btn-var btn-air" onclick="setMode('co', this)">üîµ CO</div>
                    <div class="btn-var btn-air" onclick="setMode('so2', this)">üü° SO2</div>
                    <div class="btn-var" onclick="setMode('tmp', this)">üå°Ô∏è Temp</div>
                    <div class="btn-var" onclick="setMode('rh', this)">üíß Hum</div>
                    <div class="btn-var" onclick="setMode('wsp', this)">üí® Viento</div>
                    <div class="btn-var" onclick="setMode('wdr', this)">üß≠ Dir.</div>
                    <div class="btn-var" style="grid-column: span 1;" onclick="setMode('alt', this)">‚õ∞Ô∏è Alt</div>
                    <div class="btn-var" style="grid-column: span 1;" onclick="setMode('building_vol', this)">üèôÔ∏è Urbano</div>
                </div>

                <div class="legend-panel">
                    <div class="legend-title">
                        <span id="legend-name">√çndice Aire y Salud</span>
                        <span id="legend-unit" style="color: #64748b;">Pts</span>
                    </div>
                    <div class="legend-bar" id="color-bar"></div>
                    <div class="legend-labels" id="legend-ticks"></div>

                    <div class="stats-row">
                        <div class="stat-item"><span class="stat-val" id="stat-min">--</span><span class="stat-lbl">M√≠nimo</span></div>
                        <div class="stat-item"><span class="stat-val" id="stat-avg">--</span><span class="stat-lbl">Promedio</span></div>
                        <div class="stat-item"><span class="stat-val" id="stat-max">--</span><span class="stat-lbl">M√°ximo</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer-controls">
        <button id="play-btn" class="play-btn">‚ñ∂</button>
        <div class="slider-wrapper">
            <input type="range" id="time-slider" min="0" max="24" value="24" class="modern-range">
            <div id="time-display">üî¥ EN VIVO</div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    
    <script>
        // --- 0. CONFIGURACI√ìN INICIAL ---
        const BASE_API_URL = "https://vuy3dprsp2udtuelnrb5leg6ay0ygsky.lambda-url.us-east-1.on.aws/";
        const MAPBOX_TOKEN = 'pk.eyJ1Ijoia2lsb2JhdG8iLCJhIjoiY21rYnJseG1kMDZnczNlb2xrdDhrejE1biJ9.VFEMLEntTg5fDXDefQTnFA';

        // --- DICCIONARIO DE IDIOMAS ---
        let currentLang = 'es';
        
        const I18N = {
            es: {
                live_label: "üî¥ AHORA",
                live_opt: "üî¥ AHORA (En Vivo)",
                past_label: "‚è™ PASADO",
                future_label: "üîÆ FUTURO",
                conn_live: "EN VIVO",
                conn_hist: "HIST√ìRICO",
                conn_fore: "PRON√ìSTICO",
                loading: "Cargando datos...", // <--- NUEVO
                nodata: "Datos no disponibles", // <--- NUEVO (Para errores)
                stats: { min: "M√≠nimo", avg: "Promedio", max: "M√°ximo" },
                popup: { station: "Estaci√≥n", risk: "Riesgo", inhabitants: "habitantes" },
                // AQUI ESTABA EL ERROR: Agregamos emojis a los nombres largos (Para el Men√∫)
                buttons: {
                    ias: "üö¶ √çndice Aire y Salud",
                    o3: "üî¥ Ozono (O3)", 
                    pm10: "üü§ Part√≠culas PM10", 
                    pm25: "üü£ Part√≠culas PM2.5",
                    co: "üîµ Mon√≥xido Carbono", 
                    so2: "üü° Di√≥xido Azufre", 
                    tmp: "üå°Ô∏è Temperatura", 
                    rh: "üíß Humedad",
                    wsp: "üí® Viento", 
                    wdr: "üß≠ Direcci√≥n", 
                    alt: "‚õ∞Ô∏è Altitud", 
                    building_vol: "üèôÔ∏è Densidad Urbana"
                },
                // Etiquetas cortas (Para el Popup) - Ya tienen emojis
                btn_lbl: { ias: "üö¶ IAS", o3: "üî¥ O3", pm10: "üü§ PM10", pm25: "üü£ PM2.5", co: "üîµ CO", so2: "üü° SO2", tmp: "üå°Ô∏è Temp", rh: "üíß Hum", wsp: "üí® Viento", wdr: "üß≠ Dir.", alt: "‚õ∞Ô∏è Alt", building_vol: "üèôÔ∏è Urbano" }
            },
            en: {
                live_label: "üî¥ NOW",
                live_opt: "üî¥ NOW (Live)",
                past_label: "‚è™ PAST",
                future_label: "üîÆ FORECAST",
                conn_live: "LIVE",
                conn_hist: "HISTORICAL",
                conn_fore: "FORECAST",
                loading: "Loading data...", // <--- NUEVO
                nodata: "Data not available", // <--- NUEVO
                stats: { min: "Minimum", avg: "Average", max: "Maximum" },
                popup: { station: "Station", risk: "Risk", inhabitants: "inhabitants" },
                // Agregamos emojis al Ingl√©s tambi√©n
                buttons: {
                    ias: "üö¶ Air Quality Index",
                    o3: "üî¥ Ozone (O3)", 
                    pm10: "üü§ Particulate PM10", 
                    pm25: "üü£ Particulate PM2.5",
                    co: "üîµ Carbon Monoxide", 
                    so2: "üü° Sulfur Dioxide", 
                    tmp: "üå°Ô∏è Temperature", 
                    rh: "üíß Humidity",
                    wsp: "üí® Wind Speed", 
                    wdr: "üß≠ Wind Dir.", 
                    alt: "‚õ∞Ô∏è Altitude", 
                    building_vol: "üèôÔ∏è Urban Density"
                },
                btn_lbl: { ias: "üö¶ AQI", o3: "üî¥ O3", pm10: "üü§ PM10", pm25: "üü£ PM2.5", co: "üîµ CO", so2: "üü° SO2", tmp: "üå°Ô∏è Temp", rh: "üíß Hum", wsp: "üí® Wind", wdr: "üß≠ Dir.", alt: "‚õ∞Ô∏è Elev", building_vol: "üèôÔ∏è Urban" }
            }
        };

        function setLang(lang) {
            currentLang = lang;
            
            // 1. Actualizar estilos del toggle (ES | EN)
            document.getElementById('lang-es').className = lang === 'es' ? 'lang-opt active' : 'lang-opt';
            document.getElementById('lang-en').className = lang === 'en' ? 'lang-opt active' : 'lang-opt';

            // 2. Regenerar lista de tiempos (traducir Pasado/Futuro)
            generateLocalTimeOptions();
            
            // 3. Traducir Botones de Variables
            const texts = I18N[lang].buttons;
            // Eliminamos 'btnMap' porque no se usaba. Usamos el onclick directamente:
            document.querySelectorAll('.btn-var').forEach(btn => {
                // Extrae 'ias', 'o3', etc. del atributo onclick="setMode('ias', this)"
                const match = btn.getAttribute('onclick').match(/'([^']+)'/);
                if (match && texts[match[1]]) {
                    btn.innerText = texts[match[1]];
                }
            });

            // 4. Actualizar Slider y Barra de Estado
            document.getElementById('time-slider').dispatchEvent(new Event('input'));
            
            const statusEl = document.getElementById('connection-status');
            // Usamos .includes para detectar el estado actual de forma segura
            if (statusEl.innerText.includes("VIVO") || statusEl.innerText.includes("LIVE")) statusEl.innerText = I18N[lang].conn_live;
            else if (statusEl.innerText.includes("PRON") || statusEl.innerText.includes("FORE")) statusEl.innerText = I18N[lang].conn_fore;
            else statusEl.innerText = I18N[lang].conn_hist;

            // 5. NUEVO: Traducir texto de carga (El fix que faltaba)
            const loadingText = document.getElementById('loading-text');
            if(loadingText) loadingText.innerText = I18N[lang].loading;
        }

        // --- 1. INICIALIZAR MAPA CON L√çMITES ---
        const map = L.map('map', { 
            zoomControl: false, 
            preferCanvas: true,
            renderer: L.canvas({ padding: 0.5 }),
            minZoom: 9,   // Vista Satelital ZMVM
            maxZoom: 16   // Vista Calle
        });

        // 2. ENCUADRE (TIGHT FIT)
        map.fitBounds([
            [19.10, -99.35], // Suroeste
            [19.75, -98.85]  // Noreste
        ]);
        
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // --- 3. DEFINICI√ìN DE CAPAS (S√ÅNDWICH PRO) ---
        
        // Nivel 1: Fondo (Abajo)
        map.createPane('basePane');   map.getPane('basePane').style.zIndex = 200;

        // Nivel 2: Tu Modelo (En medio)
        map.createPane('gridPane');   map.getPane('gridPane').style.zIndex = 400;

        // Nivel 3: Etiquetas y Calles (Arriba)
        map.createPane('labelsPane'); map.getPane('labelsPane').style.zIndex = 600;
        map.getPane('labelsPane').style.pointerEvents = 'none'; // Click traspasa

        // --- 4. CARGAR LOS MAPAS ---

        // A. FONDO: CARTO DARK NO LABELS (Negro Puro)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
            pane: 'basePane', 
            opacity: 1,
            maxZoom: 19,
            attribution: '¬© OpenStreetMap, ¬© CARTO'
        }).addTo(map);

        // B. TU OVERLAY PERSONALIZADO (Mapbox: Calles rojas/blancas)
        const labelsLayer = L.tileLayer(`https://api.mapbox.com/styles/v1/kilobato/cmkm0j41j009001rz6opkd82a/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}&v=1`, {
            pane: 'labelsPane', 
            opacity: 1, 
            tileSize: 512, zoomOffset: -1, maxZoom: 19
        }).addTo(map);
        
        // Filtro opcional por si el rojo/blanco brilla demasiado
        labelsLayer.getContainer().style.filter = "brightness(1)";
        
        const CONFIG = {
            ias: { name: '√çndice Aire y Salud', unit: 'Pts', min: 0, max: 200, stops: [0, 50, 100, 150, 200, 300], colors: ['#00e400', '#ffff00', '#ff7e00', '#ff0000', '#8f3f97', '#7e0023'] },
            o3: { name: 'Ozono (O3)', unit: 'ppb', min: 0, max: 200, stops: [0, 50, 100, 150, 200, 250], colors: ['#00e400', '#ffff00', '#ff7e00', '#ff0000', '#8f3f97', '#7e0023'] },
            pm10: { name: 'Part√≠culas PM10', unit: '¬µg/m¬≥', min: 0, max: 215, stops: [0, 45, 75, 130, 215, 300], colors: ['#00e400', '#ffff00', '#ff7e00', '#ff0000', '#8f3f97', '#7e0023'] },
            pm25: { name: 'Part√≠culas PM2.5', unit: '¬µg/m¬≥', min: 0, max: 150, stops: [0, 25, 45, 80, 147, 200], colors: ['#00e400', '#ffff00', '#ff7e00', '#ff0000', '#8f3f97', '#7e0023'] },
            // --- NUEVOS GASES ---
            co: { name: 'Mon√≥xido Carbono', unit: 'ppm', min: 0, max: 15, stops: [0, 9, 11, 13, 15, 20], colors: ['#00e400', '#ffff00', '#ff7e00', '#ff0000', '#8f3f97', '#7e0023'] },
            so2: { name: 'Di√≥xido Azufre', unit: 'ppb', min: 0, max: 200, stops: [0, 40, 75, 185, 300, 500], colors: ['#00e400', '#ffff00', '#ff7e00', '#ff0000', '#8f3f97', '#7e0023'] },
            // --------------------
            tmp: { name: 'Temperatura', unit: '¬∞C', min: 0, max: 35, stops: [0, 10, 20, 30, 35], colors: ['#0000ff', '#00ffff', '#ffff00', '#ff0000', '#800000'] },
            rh: { name: 'Humedad', unit: '%', min: 0, max: 100, stops: [0, 25, 50, 75, 100], colors: ['#8d6e63', '#a5d6a7', '#4dd0e1', '#0288d1', '#01579b'] },
            wsp: { name: 'Viento', unit: 'm/s', min: 0, max: 15, stops: [0, 3, 6, 9, 15], colors: ['#ffffff', '#b3e5fc', '#29b6f6', '#0277bd', '#4a148c'] },
            // NUEVO CONFIG PARA DIRECCI√ìN (0¬∞=N, 90¬∞=E, 180¬∞=S, 270¬∞=O)
            wdr: { name: 'Dir. Viento', unit: '¬∞', min: 0, max: 360, stops: [0, 90, 180, 270, 360], colors: ['#ff0000', '#ffff00', '#00ff00', '#0000ff', '#ff0000'] },
            alt: { name: 'Altitud', unit: 'm', min: 2230, max: 4000, stops: [2230, 2260, 2400, 2900, 3500, 4000], colors: ['#0d47a1', '#1b5e20', '#8bc34a', '#fbc02d', '#795548', '#eeeeee'] },
            building_vol: { name: 'Densidad Urbana', unit: 'm¬≥', min: 0, max: 1200000, stops: [0, 10000, 100000, 400000, 800000, 1200000], colors: ['#ffffff', '#e0e0e0', '#fca5a5', '#ef4444', '#b91c1c', '#7f1d1d'] }
        };

        let globalData = null;
        let fallbackData = null; 
        let currentMetric = 'ias'; 
        let geoLayer = null;

        console.log("üöÄ Iniciando Dashboard V6.5 (Safe Time Parse)");
        generateLocalTimeOptions();
        loadMapData('latest');

        function generateLocalTimeOptions() {
            const select = document.getElementById('time-select');
            select.innerHTML = ''; 
            
            // Usamos el diccionario del idioma actual
            const T = I18N[currentLang]; 
            
            const now = new Date();
            const options = [];

            // --- A. PASADO (-24h) ---
            let pastStart = new Date(now);
            pastStart.setMinutes(20); pastStart.setSeconds(0);
            
            for (let i = 24; i > 0; i--) {
                const d = new Date(pastStart.getTime() - (i * 60 * 60 * 1000));
                const val = formatDate(d, '20');
                // Etiqueta traducida: "‚è™ PASADO -xh..."
                const label = `${T.past_label} -${i}h (${formatLabel(d)})`; 
                options.push({ val, label, type: 'past' });
            }

            // --- B. PRESENTE (En Vivo) ---
            // Etiqueta traducida: "üî¥ AHORA (En Vivo)"
            options.push({ val: 'latest', label: T.live_opt, type: 'live' }); 

            // --- C. FUTURO (+24h) ---
            let futureStart = new Date(now);
            futureStart.setMinutes(0); futureStart.setSeconds(0);
            futureStart.setHours(futureStart.getHours() + 1);
            
            for (let i = 0; i < 24; i++) {
                const d = new Date(futureStart.getTime() + (i * 60 * 60 * 1000));
                const val = formatDate(d, '00');
                // Etiqueta traducida: "üîÆ FUTURO +xh..."
                const label = `${T.future_label} +${i+1}h (${formatLabel(d)})`; 
                options.push({ val, label, type: 'future' });
            }

            // Renderizar en el HTML
            options.forEach((opt, index) => {
                const el = document.createElement('option');
                el.value = opt.val; 
                el.innerText = opt.label;
                el.dataset.type = opt.type; 
                el.dataset.index = index;
                
                if(opt.type === 'live') el.selected = true;
                select.appendChild(el);
            });
            
            // Ajustar Slider
            const slider = document.getElementById('time-slider');
            slider.max = options.length - 1;
            
            // Mantenemos la posici√≥n si es posible, si no, vamos al Live (24)
            if (slider.value == 0 || slider.value == 24) slider.value = 24;
        }

        // --- FUNCIONES AUXILIARES DE FORMATO ---
        function formatDate(d, forceMin) {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const hour = String(d.getHours()).padStart(2, '0');
            return `${year}-${month}-${day}_${hour}-${forceMin}`;
        }

        function formatLabel(d) {
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const hour = String(d.getHours()).padStart(2, '0');
            const min = String(d.getMinutes()).padStart(2, '0');
            return `${day}/${month} ${hour}:${min}`;
        }

        // --- VINCULACI√ìN DEL SLIDER ---
        const timeSlider = document.getElementById('time-slider');
        const timeDisplay = document.getElementById('time-display');
        const timeSelect = document.getElementById('time-select');
        
        timeSlider.addEventListener('input', (e) => {
            const index = parseInt(e.target.value);
            const options = timeSelect.options;
            const T = I18N[currentLang];

            if (options[index]) {
                timeSelect.selectedIndex = index;
                const opt = options[index];
                const type = opt.dataset.type;
                
                let color = "#fff";
                let statusLabel = "";
                let displayTime = "";

                if (type === 'live') {
                    color = "#22c55e"; 
                    // Obtener hora del texto o del sistema
                    if (opt.innerText.includes("-") && opt.innerText.includes(":")) {
                        displayTime = opt.innerText.split("-").pop(); 
                    } else {
                        const n = new Date();
                        displayTime = " " + String(n.getHours()).padStart(2,'0') + ":" + String(n.getMinutes()).padStart(2,'0');
                    }
                    statusLabel = `${T.live_label} ${displayTime}`;
                    timeDisplay.innerHTML = `<span class="live-dot" style="background:${color}; box-shadow:0 0 6px ${color};"></span> <span style="color:${color}; font-weight:bold;">${statusLabel}</span>`;
                } else {
                    if (type === 'future') { color = "#a855f7"; statusLabel = T.future_label; } 
                    else { color = "#38bdf8"; statusLabel = T.past_label; }
                    
                    // Limpiar texto repetido
                    let cleanText = opt.innerText.replace(T.future_label, "").replace(T.past_label, "").replace("üîÆ", "").replace("‚è™", "").trim();
                    timeDisplay.innerHTML = `<span style="color:${color}; font-weight:bold; margin-right:5px;">${statusLabel}</span> <span style="color:#cbd5e1; font-family:'Roboto Mono'; font-size:11px;">${cleanText}</span>`;
                }
                loadMapData(opt.value);
            }
        });

        // --- L√ìGICA PLAY/PAUSE ---
        let isPlaying = false;
        let playInterval;

        document.getElementById('play-btn').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar && !sidebar.classList.contains('collapsed')) sidebar.classList.add('collapsed');

            isPlaying = !isPlaying;
            this.innerText = isPlaying ? "‚è∏" : "‚ñ∂";

            if (isPlaying) {
                if (parseInt(timeSlider.value) >= parseInt(timeSlider.max)) {
                    timeSlider.value = 0; // Rebobinar al inicio del pasado
                    timeSlider.dispatchEvent(new Event('input'));
                }
                playInterval = setInterval(() => {
                    let nextVal = parseInt(timeSlider.value) + 1;
                    if (nextVal > parseInt(timeSlider.max)) {
                        clearInterval(playInterval);
                        isPlaying = false;
                        this.innerText = "‚ñ∂";
                        
                        // VOLVER A LIVE AUTOM√ÅTICAMENTE
                        let liveIndex = 0;
                        for (let i = 0; i < timeSelect.options.length; i++) {
                            if (timeSelect.options[i].dataset.type === 'live') { liveIndex = i; break; }
                        }
                        timeSlider.value = liveIndex;
                        timeSlider.dispatchEvent(new Event('input'));
                    } else {
                        timeSlider.value = nextVal;
                        timeSlider.dispatchEvent(new Event('input'));
                    }
                }, 1500);
            } else {
                clearInterval(playInterval);
            }
        });

        function changeTime() {
            const select = document.getElementById('time-select');
            const slider = document.getElementById('time-slider');
            slider.value = select.selectedIndex;
            slider.dispatchEvent(new Event('input'));
        }
        // --- [FIN ANCLA B] ---

        function loadMapData(forceTimestamp = null) {
            const select = document.getElementById('time-select');
            const timestampKey = forceTimestamp || select.value;
            const selectedOpt = select.options[select.selectedIndex];
            const type = selectedOpt ? selectedOpt.dataset.type : 'live';
            const T = I18N[currentLang]; // Textos actuales

            document.getElementById('loading').style.display = 'flex';
            document.getElementById('main-content').style.opacity = '0.3';
            
            let url = BASE_API_URL;
            if (type === 'future') { url += `?mode=forecast_data&timestamp=${timestampKey}`; }
            else if (type === 'past') { url += `?mode=map&timestamp=${timestampKey}`; }
            else { url += `?mode=map`; }
            url += `&_t=${Date.now()}`;

            fetch(url)
                .then(response => { if(!response.ok) throw new Error("Datos no encontrados"); return response.json(); })
                .then(data => {
                    data.forEach(p => {
                        p.o3 = p['o3 1h'] || p.o3; p.pm10 = p['pm10 12h'] || p.pm10;
                        p.pm25 = p['pm25 12h'] || p.pm25; p.co = p['co 8h'] || p.co; p.so2 = p['so2 1h'] || p.so2;
                    });
                    globalData = data;
                    
                    const statusEl = document.getElementById('connection-status');
                    const dotEl = document.getElementById('dot-indicator');
                    const timeEl = document.getElementById('update-time');
                    const sliderDisplay = document.getElementById('time-display');

                    // 1. Extraer la HORA REAL del dato (API)
                    let realTimeStr = "--:--";
                    if(data.length > 0 && data[0].timestamp) { 
                        // "2026-01-26 13:20:00" -> "13:20"
                        realTimeStr = data[0].timestamp.substring(11, 16); 
                    }
                    timeEl.innerText = realTimeStr;

                    // 2. L√≥gica de UI seg√∫n Tipo
                    if (type === 'live') {
                        fallbackData = data;
                        statusEl.innerText = T.conn_live; // Traducido
                        statusEl.style.color = "#22c55e"; dotEl.style.backgroundColor = "#22c55e"; dotEl.style.boxShadow = "0 0 6px #22c55e";
                        
                        // FIX HORA SLIDER: Usamos realTimeStr, no la hora del sistema
                        sliderDisplay.innerHTML = `<span class="live-dot" style="background:#22c55e; box-shadow:0 0 6px #22c55e;"></span> <span style="color:#22c55e; font-weight:bold;">${T.live_label} ${realTimeStr}</span>`;
                    } 
                    else if (type === 'future') {
                        statusEl.innerText = T.conn_fore; // Traducido
                        statusEl.style.color = "#a855f7"; dotEl.style.backgroundColor = "#a855f7"; dotEl.style.boxShadow = "0 0 6px #a855f7";
                        // Actualizamos tambi√©n el slider por si acaso
                        let label = selectedOpt.innerText.replace(T.future_label, "").replace("üîÆ", "").trim();
                        sliderDisplay.innerHTML = `<span style="color:#a855f7; font-weight:bold;">${T.future_label}</span> <span style="color:#cbd5e1; font-family:'Roboto Mono'; font-size:11px;">${label}</span>`;
                    } 
                    else {
                        statusEl.innerText = T.conn_hist; // Traducido
                        statusEl.style.color = "#38bdf8"; dotEl.style.backgroundColor = "#38bdf8"; dotEl.style.boxShadow = "0 0 6px #38bdf8";
                        let label = selectedOpt.innerText.replace(T.past_label, "").replace("‚è™", "").trim();
                        sliderDisplay.innerHTML = `<span style="color:#38bdf8; font-weight:bold;">${T.past_label}</span> <span style="color:#cbd5e1; font-family:'Roboto Mono'; font-size:11px;">${label}</span>`;
                    }
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                    document.getElementById('main-content').style.opacity = '1';
                    
                    renderMap(); // Redibujar mapa con textos traducidos
                    updateLegendAndStats(); // Actualizar leyenda traducida
                })
                .catch(err => {
                    console.error("Error:", err);
                    const T = I18N[currentLang];
                    document.getElementById('loading').innerHTML = `<div style="color:#ef4444">${T.nodata}<br>(${type})</div>`;
                });
        }

        function changeTime() {
            const select = document.getElementById('time-select');
            const slider = document.getElementById('time-slider');

            // 1. Mover el punto del Slider a la opci√≥n seleccionada
            slider.value = select.selectedIndex;

            // 2. Disparar manualmente el evento 'input' del Slider
            // Esto es un truco muy limpio: obliga al slider a ejecutar su l√≥gica,
            // lo cual actualizar√° el texto (timeDisplay), los colores (Pasado/Futuro)
            // y llamar√° a loadMapData() autom√°ticamente.
            slider.dispatchEvent(new Event('input'));
        }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }

        function getColor(val, metric) {
            const conf = CONFIG[metric];
            let v = Number(val || 0);
            v = Math.max(conf.min, Math.min(v, conf.max));
            const stops = conf.stops;
            for (let i = 0; i < stops.length - 1; i++) {
                if (v >= stops[i] && v <= stops[i+1]) {
                    const t = (v - stops[i]) / (stops[i+1] - stops[i]);
                    const c1 = hexToRgb(conf.colors[i]);
                    const c2 = hexToRgb(conf.colors[i+1]);
                    return `rgb(${lerp(c1.r, c2.r, t)}, ${lerp(c1.g, c2.g, t)}, ${lerp(c1.b, c2.b, t)})`;
                }
            }
            return conf.colors[0];
        }

        function hexToRgb(hex) { const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : {r:0,g:0,b:0}; }
        function lerp(start, end, t) { return Math.round(start + (end - start) * t); }

        function renderMap() {
            if (!globalData) return;
            if (geoLayer) map.removeLayer(geoLayer);
            
            const conf = CONFIG[currentMetric]; 
            const T = I18N[currentLang]; 
            
            const RECT_SIZE = 0.005;
            const OVERLAP = 1.03;
            const rectangles = []; 

            let dataKey = currentMetric;
            if (currentMetric === 'alt') dataKey = 'altitude'; 

            for(let i=0; i < globalData.length; i++) {
                let p = globalData[i];
                let val = p[dataKey];
                
                if ((dataKey === 'altitude' || dataKey === 'building_vol') && (!val || val === 0)) {
                    if (fallbackData && fallbackData[i]) { val = fallbackData[i][dataKey]; }
                }

                val = Number(val || 0);
                const color = getColor(val, currentMetric);
                
                const bounds = [
                    [p.lat - (RECT_SIZE * OVERLAP), p.lon - (RECT_SIZE * OVERLAP)], 
                    [p.lat + (RECT_SIZE * OVERLAP), p.lon + (RECT_SIZE * OVERLAP)]
                ];
                const isStation = p.station ? true : false;
                const fillOp = isStation ? 0.9 : 0.65;
                const rect = L.rectangle(bounds, {
                        pane: 'gridPane',
                        stroke: isStation,      
                        color: '#ffffff', 
                        weight: isStation ? 2 : 0, 
                        fillOpacity: fillOp, 
                        fillColor: color,
                        interactive: true
                    });

                const riskColor = (p.risk === 'Alto' || p.risk === 'Muy Alto' || p.risk === 'Extremadamente Alto') ? '#ef4444' : (p.risk === 'Moderado' ? '#eab308' : '#22c55e');
                const fmtPob = (n) => { if (!n || n === 0) return ''; if (n >= 1000) return `üë• ${(n/1000).toFixed(1)}k`; return `üë• ${n}`; };
                
                let loc_text = `üìç ${p.lat.toFixed(2)}, ${p.lon.toFixed(2)}`;
                if (p.col && p.col !== 'Zona Federal / Sin Colonia') { loc_text = `üìç ${p.col}, ${p.mun}`; } 
                else if (p.mun && p.mun !== 'Valle de M√©xico' && p.mun !== 'ZMVM') { loc_text = `üìç ${p.mun}, ${p.edo || ''}`; }
                
                const pob_text = p.pob ? `${fmtPob(p.pob)} ${T.popup.inhabitants}` : ''; 
                
                let bVol = Number(p.building_vol || 0);
                let altVal = Number(p.altitude || 0);
                if (bVol === 0 && fallbackData && fallbackData[i]) bVol = Number(fallbackData[i].building_vol || 0);
                if (altVal === 0 && fallbackData && fallbackData[i]) altVal = Number(fallbackData[i].altitude || 0);

                let headerHTML = `<div style="font-size:10px; color:#64748b; text-align:right; margin-bottom:4px; font-weight:600;">üïí ${p.timestamp || 'Live'}</div>`;
                if (isStation) { headerHTML += `<div style="background:#38bdf8; color:#0f172a; padding:4px 8px; border-radius:4px; margin-bottom:8px; text-align:center; font-weight:bold; font-size:12px;">üì° ${T.popup.station}: ${p.station}</div>`; }

                let sourcesObj = {};
                try { if (p.sources) sourcesObj = JSON.parse(p.sources); } catch (e) {}
                const fmtSrc = (pol) => {
                    let src = sourcesObj[pol];
                    if (!src) src = "IA";
                    let displayLabel = src.replace(" 1h", "").replace(" 12h", "").replace(" 8h", "");
                    const isIA = displayLabel.includes("IA");
                    const color = isIA ? '#94a3b8' : '#0ea5e9'; 
                    const weight = isIA ? '400' : '700';
                    return `<span style="font-size:0.7em; color:${color}; margin-left:3px; font-weight:${weight}; display:inline-block; vertical-align:middle;">(${displayLabel})</span>`;
                };

                // --- POPUP LIMPIO (Sin emojis manuales, usa los del diccionario) ---
                rect.bindPopup(`
                    <div style="font-family:'Inter'; color:#334155; min-width: 195px;">
                        ${headerHTML}
                        <div style="margin-bottom:8px; border-bottom:1px solid #e2e8f0; padding-bottom:4px;">
                            <div style="font-size:11px; font-weight:700; color:#3b82f6; margin-bottom:1px;">${loc_text}</div>
                            <div style="font-size:10px; color:#64748b;">${pob_text}</div>
                        </div>
                        <div style="display:grid; grid-template-columns: auto 1fr; gap: 4px 10px; font-size:12px; align-items: center;">
                            <span style="font-weight:600; color:#000;">${T.btn_lbl.ias}:</span> <span style="font-weight:bold;">${Number(p.ias||0).toFixed(0)} pts</span>
                            <span style="font-weight:600; color:#000;">‚ò¢Ô∏è ${T.popup.risk}:</span> <span style="font-weight:bold; color:${riskColor};">${p.risk || 'N/A'}</span>
                            
                            <span style="font-weight:600; color:#000; white-space:nowrap;">${T.btn_lbl.o3} <span style="font-size:9px; color:#64748b;">(1h)</span>${p.dominant === 'O3' ? ' <b style="color:#ef4444;">(Dom)</b>' : ''}:</span> 
                            <span style="white-space:nowrap;">${Number(p.o3||0).toFixed(1)} ppb ${fmtSrc('o3')}</span>
                            
                            <span style="font-weight:600; color:#000; white-space:nowrap;">${T.btn_lbl.pm10} <span style="font-size:9px; color:#64748b;">(12h)</span>${p.dominant === 'PM10' ? ' <b style="color:#a855f7;">(Dom)</b>' : ''}:</span> 
                            <span style="white-space:nowrap;">${Number(p.pm10||0).toFixed(1)} ¬µg ${fmtSrc('pm10')}</span>
                            
                            <span style="font-weight:600; color:#000; white-space:nowrap;">${T.btn_lbl.pm25} <span style="font-size:9px; color:#64748b;">(12h)</span>${p.dominant === 'PM2.5' ? ' <b style="color:#a855f7;">(Dom)</b>' : ''}:</span> 
                            <span style="white-space:nowrap;">${Number(p.pm25||0).toFixed(1)} ¬µg ${fmtSrc('pm25')}</span>

                            <span style="font-weight:600; color:#000; white-space:nowrap;">${T.btn_lbl.co}:</span> <span>${Number(p.co||0).toFixed(2)} ppm ${fmtSrc('co')}</span>
                            <span style="font-weight:600; color:#000; white-space:nowrap;">${T.btn_lbl.so2}:</span> <span>${Number(p.so2||0).toFixed(1)} ppb ${fmtSrc('so2')}</span>

                            <hr style="grid-column: span 2; border:0; border-top:1px solid #e2e8f0; width:100%; margin:4px 0;">
                            
                            <span style="color:#475569;">${T.btn_lbl.building_vol}:</span> <span>${(bVol/1000).toFixed(0)}k m¬≥</span>
                            <span style="color:#475569;">${T.btn_lbl.tmp}:</span> <span>${Number(p.tmp||0).toFixed(1)} ¬∞C ${fmtSrc('tmp')}</span>
                            <span style="color:#475569;">${T.btn_lbl.rh}:</span> <span>${Number(p.rh||0).toFixed(0)} % ${fmtSrc('rh')}</span>
                            <span style="color:#475569;">${T.btn_lbl.wsp}:</span> <span>${Number(p.wsp||0).toFixed(1)} m/s ${fmtSrc('wsp')}</span>
                            <span style="color:#475569;">${T.btn_lbl.wdr}:</span> <span>${Number(p.wdr||0).toFixed(0)}¬∞ ${fmtSrc('wdr')}</span>
                            <span style="color:#475569;">${T.btn_lbl.alt}:</span> <span>${altVal.toFixed(0)} m</span>
                        </div>
                    </div>
                `);

                rect.on('mouseover', function() {
                    this.setStyle({ fillOpacity: 0.9, weight: isStation ? 4 : 1, color: isStation ? '#ffffff' : 'rgba(255, 255, 255, 0.5)', stroke: true });
                    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) { this.bringToFront(); }
                });

                rect.on('mouseout', function() {
                    this.setStyle({ fillOpacity: fillOp, weight: isStation ? 2 : 0, stroke: isStation, color: '#ffffff' });
                });
                rectangles.push(rect);
            }
            geoLayer = L.layerGroup(rectangles).addTo(map);
            updateLegendAndStats(); 
        }

        function updateLegendAndStats() {
            if (!globalData || globalData.length === 0) return;
            
            const conf = CONFIG[currentMetric];
            const T = I18N[currentLang];
            
            // Calcular estad√≠sticas
            let vals = [];
            let dataKey = currentMetric === 'alt' ? 'altitude' : currentMetric;
            for(let i=0; i < globalData.length; i++) {
                let v = globalData[i][dataKey];
                if((!v || v===0) && fallbackData && fallbackData[i]) v = fallbackData[i][dataKey];
                vals.push(Number(v||0));
            }
            const min = Math.min(...vals);
            const max = Math.max(...vals);
            const avg = vals.reduce((a,b)=>a+b,0)/vals.length;

            // 1. Traducir T√≠tulo Leyenda (Usamos el nombre largo del diccionario)
            document.getElementById('legend-name').innerText = T.buttons[currentMetric]; 
            document.getElementById('legend-unit').innerText = conf.unit;

            // 2. Renderizar Barra Color
            let gradStr = 'linear-gradient(to right';
            for(let i=0; i<conf.stops.length; i++) {
                let pct = ((conf.stops[i] - conf.min) / (conf.max - conf.min)) * 100;
                gradStr += `, ${conf.colors[i]} ${pct}%`;
            }
            gradStr += ')';
            document.getElementById('color-bar').style.background = gradStr;
            document.getElementById('legend-ticks').innerHTML = conf.stops.map(s => `<span>${s}</span>`).join('');

            // 3. Traducir Etiquetas de Estad√≠sticas (M√≠nimo / Promedio / M√°ximo)
            document.querySelector('#stat-min + .stat-lbl').innerText = T.stats.min;
            document.querySelector('#stat-avg + .stat-lbl').innerText = T.stats.avg;
            document.querySelector('#stat-max + .stat-lbl').innerText = T.stats.max;

            // 4. Poner valores
            document.getElementById('stat-min').innerText = min.toFixed(1);
            document.getElementById('stat-max').innerText = max.toFixed(1);
            document.getElementById('stat-avg').innerText = avg.toFixed(1);
        }

        window.setMode = (mode, el) => {
            currentMetric = mode;
            document.querySelectorAll('.btn-var').forEach(b => b.classList.remove('active'));
            if(el) el.classList.add('active');
            renderMap();
        };
        // --- COPIAR DESDE AQU√ç ---
        function scheduleNextUpdate() {
            const now = new Date();
            const nextUpdate = new Date(now);
        
            // Si ya pasamos el minuto 20 de esta hora, programamos para la siguiente hora
            if (now.getMinutes() >= 20) {
                nextUpdate.setHours(now.getHours() + 1);
            }
            
            nextUpdate.setMinutes(20);
            nextUpdate.setSeconds(20);
            nextUpdate.setMilliseconds(0);
        
            const msUntilUpdate = nextUpdate.getTime() - now.getTime();
            
            console.log(`üîÑ Pr√≥xima actualizaci√≥n en: ${(msUntilUpdate / 1000 / 60).toFixed(1)} min`);
        
            setTimeout(() => {
                console.log("üöÄ Ejecutando Auto-Refresh Programado...");
                loadMapData('latest'); 
                generateLocalTimeOptions(); 
                scheduleNextUpdate(); // Re-ciclar
            }, msUntilUpdate);
        }
        scheduleNextUpdate();
        // --- HASTA AQU√ç ---
    </script>
</body>
</html>
